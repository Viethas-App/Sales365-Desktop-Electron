{"version":3,"file":"default-src_app_cafe_services_bill_service_ts.js","mappings":"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","sources":["./src/app/cafe/services/bill.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { LanguageService } from './language.service';\r\nimport { VhAlgorithm, VhAuth, VhQueryCafe } from 'ionic-vhframeworks';\r\nimport { VhComponent } from '../components/vh-component/vh-component';\r\nimport { NzMessageService } from 'ng-zorro-antd/message';\r\nimport { Router } from '@angular/router';\r\nimport { VhOrderInvoices } from '../interface/vh-order-invoice';\r\nimport { VhBookingInvoiceDetail } from '../interface/vh-booking';\r\nimport { VhType } from '../interface/vh-type';\r\n\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class BillService {\r\n\r\n  /** Danh sách thuế */\r\n  listTax: any = this.vhQueryCafe.getlocalTaxs().filter(tax => tax.status);\r\n\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private vhQueryCafe: VhQueryCafe,\r\n    private vhAuth: VhAuth,\r\n    private vhAlgorithm: VhAlgorithm,\r\n    private vhComponent: VhComponent,\r\n    private nzMessageService: NzMessageService,\r\n    private router: Router,\r\n  ) { }\r\n\r\n\r\n\r\n  /**\r\n   * Trả về tên của phương thức thanh toán\r\n   * @param payment_type Loại thanh toán\r\n   * @param id_wallet\r\n   * @returns 1: Tiền mặt, 2: Thẻ, 3: Ví\r\n   */\r\n  getPaymentName(payment_type: 1 | 2 | 3, id_wallet: string = null) {\r\n    switch (payment_type) {\r\n      case 1: return this.languageService.translate('Cash');\r\n      case 2: return this.languageService.translate('Debit');\r\n      case 3: return this.vhQueryCafe.getlocalWallet(id_wallet)?.name;\r\n    }\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * hàm get điểm tích lũy theo hóa đơn\r\n   * 1. get hạng khách hàng\r\n   * 2. từ hạng khách hàng get tích điểm theo bill\r\n   * 3. check các điều kiện của chương trình\r\n   * a check sản phẩm khuyến mãi include_promotion_product\r\n   * b  check giảm giá/ chiết khấu include_discount\r\n   * c check thanh toán = điểm thưởng include_paid_points\r\n   * d check phí  include_fee\r\n   * e check thuế include_tax\r\n   * @returns 0 | number\r\n   */\r\n  getEarningPointBill(program_bill, selectedBill: VhOrderInvoices, subTotal, billDetails) {\r\n    if (program_bill && subTotal > program_bill.bill_total_minimum) {\r\n      let sub = subTotal;\r\n      if (!program_bill.include_promotion_product) {\r\n        // ko tích điểm sp có km =>  tính lại subTotal\r\n        sub = this.getSubTotalNotPromotion(billDetails);\r\n        if (program_bill.include_discount) {\r\n          sub = sub - selectedBill.getDiscount() - selectedBill.getDiscountBill();\r\n        }\r\n        if (program_bill.include_paid_points && selectedBill.getDiscountPoint()) {\r\n          sub = sub - selectedBill.getDiscountPoint();\r\n        }\r\n        if (program_bill.include_fee) {\r\n          sub += selectedBill.getFee();\r\n        }\r\n        if (program_bill.include_tax) {\r\n          sub += sub * (selectedBill.getTax() / 100);\r\n        }\r\n        return ((sub - (sub % program_bill.exchange.money)) / program_bill.exchange.money) * program_bill.exchange.points;\r\n      }\r\n      else {\r\n        if (program_bill.include_discount) {\r\n          sub = sub - selectedBill.getDiscount() - selectedBill.getDiscountBill();\r\n        }\r\n        if (program_bill.include_paid_points && selectedBill.getDiscountPoint()) {\r\n          sub = sub - selectedBill.getDiscountPoint();\r\n        }\r\n        if (program_bill.include_fee) {\r\n          sub += selectedBill.getFee();\r\n        }\r\n        if (program_bill.include_tax) {\r\n          sub += sub * (selectedBill.getTax() / 100);\r\n        }\r\n        return ((sub - (sub % program_bill.exchange.money)) / program_bill.exchange.money) * program_bill.exchange.points;\r\n      }\r\n    }\r\n    else {\r\n      return 0;\r\n    }\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Trả về tổng tiền của sản phẩm ko có chương trình khuyến mãi\r\n   * @param billDetails Mảng billDetails cần tính\r\n   * @returns Tổng tiền của sản phẩm ko có chương trình khuyến mãi\r\n   */\r\n  getSubTotalNotPromotion(billDetails: any[]) {\r\n    return billDetails\r\n      .filter((item) => !item.id_promotion)\r\n      .reduce((prev: number, next) => prev + next.quantity * next.price, 0);\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Trả về điểm được tích của sản phẩm được thêm.\r\n   * @param product sản phẩm được thêm\r\n   * @param promotion Khuyến mãi áp dụng\r\n   * @param program_product Chương trình tích điểm\r\n   * @returns 0 | number\r\n   */\r\n  getTotalEarningPointProduct(product, promotion, program_product): number {\r\n    if (program_product) {\r\n      let subTotal = 0;\r\n      if (!program_product.include_promotion_product && promotion) { // tích điểm sp có km =>  tính lại subTotal\r\n        subTotal = program_product.products.find(i => i == product._id) ? product.price : 0;\r\n        return ((subTotal - subTotal % program_product.exchange.money) / program_product.exchange.money) * program_product.exchange.points;\r\n      }\r\n      else {\r\n        subTotal = program_product.products.find(i => i == product._id) ? product.price : 0;\r\n        return ((subTotal - subTotal % program_product.exchange.money) / program_product.exchange.money) * program_product.exchange.points;\r\n      }\r\n    }\r\n    else return 0;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Trả về tổng tiền của sản phẩm ko có chương trình khuyến mãi thuộc chương trình tích điểm sản phẩm\r\n   * @param products_of_program_earnig_product Mảng sản phẩm thuộc chương trình tích điểm sản phẩm\r\n   * @param billDetails Mảng billDetails cần tính\r\n   * @returns Tổng tiền của sản phẩm ko có chương trình khuyến mãi thuộc chương trình tích điểm sản phẩm\r\n   */\r\n  getSubTotalNotPromotionOfProduct(products_of_program_earnig_product, billDetails): number {\r\n    return billDetails\r\n      .filter(item => item.price_origin == item.price && products_of_program_earnig_product.find(i => i == item.id_product || i == item.id_subproduct))\r\n      .reduce((prev: number, next) => prev + next.quantity * next.price, 0);\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Trả về tổng điểm được tích của hoá đơn và sản phẩm.\r\n   * = Tổng điểm tích được của tất cả sản phẩm + Tổng điểm tích được của hoá đơn\r\n   * @returns 0 | number\r\n   */\r\n  getTotalEarningPoint(program_product, program_bill, subTotal, selectedBill, billDetails): number {\r\n    const earning_point = this.getEarningPointAllProduct(program_product, billDetails) + this.getEarningPointBill(program_bill, selectedBill, subTotal, billDetails);\r\n    return earning_point ? earning_point : 0;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Hàm này trả về tổng điểm được tích của tất cả sản phẩm\r\n   * @param program_product chương trình tích điểm sản phẩm\r\n   * @param billDetails mảng billDetails\r\n   * @returns 0 | number\r\n   */\r\n  getEarningPointAllProduct(program_product, billDetails): number {\r\n    if (program_product) {\r\n      let subTotal = 0;\r\n      if (!program_product.include_promotion_product) { // tích điểm sp có km => tính lại subTotal\r\n        subTotal = this.getSubTotalNotPromotionOfProduct(program_product.products, billDetails);\r\n        return ((subTotal - subTotal % program_product.exchange.money) / program_product.exchange.money) * program_product.exchange.points;\r\n      }\r\n      else {\r\n        subTotal = billDetails.filter(item => item.price_origin == item.price && program_product.products\r\n          .find(i => i == item.id_product))\r\n          .reduce((prev: number, next) => prev + next.quantity * next.price, 0);\r\n        return ((subTotal - subTotal % program_product.exchange.money) / program_product.exchange.money) * program_product.exchange.points;\r\n      }\r\n    }\r\n    else return 0;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Tạo đơn hàng với bill_type 5 và route đến trang chi tiết đơn hàng\r\n   * @param selectedAreaID id của khu vực được chọn\r\n   * @param selectedTableID id của bàn được chọn\r\n   * @param searchValueAreaGoHome Giá trị ô input search đơn go_home\r\n   * @param indexTabArea Index của tab Area (khu vực) được chọn\r\n   * @param filterType loại bộ lọc\r\n   */\r\n  createBill(selectedAreaID, selectedTableID, searchValueAreaGoHome, indexTabArea, filterType) {\r\n    let dataRestore = { indexTab: indexTabArea, searchValue: searchValueAreaGoHome, filterType: filterType, id_area: selectedAreaID };\r\n    if (selectedAreaID != 'go_home' && !selectedTableID) {\r\n      this.nzMessageService.warning(this.languageService.translate(\"Please select a table\"));\r\n    }\r\n    else {\r\n      this.vhComponent.showLoading('').then(() => {\r\n        this.vhQueryCafe.createBill_Billdetail({\r\n          payment_type: 1,\r\n          date: (new Date()).toISOString(),\r\n          id_customer: 'id_retail',\r\n          tax_buyerDisplayName: 'Người mua không lấy hoá đơn',\r\n          tax_buyerLegalName: '',\r\n          tax_buyerTaxCode: '',\r\n          tax_buyerAddressLine: '',\r\n          tax_buyerEmail: '',\r\n          id_table: selectedTableID,\r\n          id_area: selectedAreaID,\r\n          id_branch: this.vhQueryCafe.getDefaultBranch()._id,\r\n          id_employee: this.vhAuth.getUser()._id,\r\n          id_wallet: 'id_cash',\r\n          total: 0,\r\n          payment: 0,\r\n          tax: 0,\r\n          discount: 0,\r\n          fee: 0,\r\n          bill_type: 5,\r\n          note: '',\r\n          cash: 0,\r\n        }, [])\r\n          .then((bill: any) => {\r\n            if (selectedTableID != 'go_home') {\r\n              Promise.all([\r\n                this.vhQueryCafe.updateTable(selectedTableID, { status: true }),\r\n                this.vhComponent.hideLoading(0)\r\n              ]).then(() => {\r\n                this.router.navigate(['/cafe/cafe-fnb/detail'],\r\n                  {\r\n                    state: { id_table: selectedTableID, id_area: selectedAreaID, id_bill: bill._id, dataRestore }\r\n                  });\r\n              });\r\n            }\r\n            else {\r\n              this.vhComponent.hideLoading(0).then(() => {\r\n                this.router.navigate(['/cafe/cafe-fnb/detail'],\r\n                  {\r\n                    state: { id_table: selectedTableID, id_area: selectedAreaID, id_bill: bill._id, dataRestore }\r\n                  });\r\n              });\r\n            }\r\n          }, (error: any) => {\r\n            console.log('error ', error);\r\n          });\r\n      });\r\n    }\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Lưu hóa đơn.\r\n   *\r\n   * Nếu là bàn go_home thì chỉ lưu hóa đơn.\r\n   * Nếu không phải bàn go_home thì lưu hóa đơn và cập nhật trạng thái bàn.\r\n   *\r\n   * @returns Promise<void>\r\n   *\r\n   * @example\r\n   * this.saveBill(selectedBill).then(() => {console.log('success')}).catch((error) => {console.log(error)});\r\n   */\r\n  saveBill(selectedBill: VhOrderInvoices) {\r\n    if (selectedBill.getIdTable() == 'go_home') {\r\n      return Promise.all([this.vhQueryCafe.saveBill_Billdetail(selectedBill.getID(), 1)]);\r\n    }\r\n    else {\r\n      return Promise.all([\r\n        this.vhQueryCafe.saveBill_Billdetail(selectedBill.getID(), 1),\r\n        this.vhQueryCafe.updateTable(selectedBill.getIdTable(), { status: false })\r\n      ]);\r\n    }\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Lấy danh sách bill mang về với id_table = go_home và bill_type = 5\r\n   * @returns Danh sách bill mang về\r\n   *\r\n   * @example\r\n   * this.getBillsGoHome().then((bills) => {console.log(bills)}).catch((error) => {console.log(error)});\r\n   */\r\n  getBillsGoHome(): Promise<any[]> {\r\n    return this.vhQueryCafe.getBills_byFields({ id_table: { $eq: 'go_home' }, bill_type: { $eq: 5 }, id_branch: { $eq: this.vhQueryCafe.getDefaultBranch()._id } })\r\n      .then((bills: any) => {\r\n        return bills.map((item) => ({\r\n          ...item,\r\n          customerName: this.vhQueryCafe.getlocalCustomer(item.id_customer)?.name || 'Unknown',\r\n          customerPhone: this.vhQueryCafe.getlocalCustomer(item.id_customer)?.phone || 'Unknown',\r\n          employeeName: this.vhAuth.getlocalEmployee(item.id_employee)?.name || 'Unknown',\r\n          paymentName: this.getPaymentName(item.payment_type, item.id_wallet),\r\n        }));\r\n      })\r\n      .catch((err) => {\r\n        console.error(err);\r\n      });\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Tìm kiếm hóa đơn mang về theo các trường được chỉ định.\r\n   * Nếu không có trường nào được chỉ định, mặc định sẽ tìm kiếm theo các trường: bill_code, employeeName, customerPhone, customerName.\r\n   * @param value Giá trị tìm kiếm\r\n   * @param billsGoHome Danh sách hóa đơn mang về\r\n   * @param fields Danh sách các trường để tìm kiếm, mặc định là ['bill_code', 'employeeName', 'customerPhone', 'customerName']\r\n   * @returns Danh sách hóa đơn mang về đã được lọc theo giá trị tìm kiếm\r\n   */\r\n  searchBillGoHome(value: string, billsGoHome: any[], fields?: string[]): any[] {\r\n    const searchFields = fields || ['bill_code', 'employeeName', 'customerPhone', 'customerName'];\r\n    if (value.length) {\r\n      const val: string = this.vhAlgorithm.changeAlias(value.trim().toLowerCase());\r\n      return this.vhAlgorithm.searchList(val, billsGoHome, searchFields);\r\n    }\r\n    else {\r\n      return [...billsGoHome];\r\n    }\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Lấy invoiceDetails theo id_bill\r\n   * @param id_bill _id của bill cần lấy \r\n   */\r\n  getBillDetailsByIdBill(id_bill: string): Promise<any> {\r\n    return new Promise((resolve, reject) => {\r\n      this.vhQueryCafe.getBill_details_byId_bill(id_bill).then((invoiceDetails: any) => {\r\n        let invoiceDetailsFresh: any = invoiceDetails.map((item) => {\r\n          if (item.toppings) {\r\n            item.toppings = item.toppings.map((element) => {\r\n              return {\r\n                ...element,\r\n                name: this.vhQueryCafe.getlocalDetailProduct(element.id_subproduct ? element.id_subproduct: element.id_product).name\r\n              };\r\n            });\r\n          }\r\n          if (item.combos) {\r\n            item.combos = item.combos.map((element) => {\r\n              return {\r\n                ...element,\r\n                name: this.vhQueryCafe.getlocalDetailProduct(element.id_subproduct ? element.id_subproduct: element.id_product).name\r\n              };\r\n            });\r\n          }\r\n          return {\r\n            ...item,\r\n            name: this.vhQueryCafe.getlocalDetailProduct(item.id_subproduct ? item.id_subproduct: item.id_product).name\r\n          };\r\n        });\r\n        resolve(invoiceDetailsFresh);\r\n      }).catch((error) => {\r\n        console.error(error);\r\n        reject(error);\r\n      });\r\n    });\r\n  }\r\n  \r\n  \r\n  \r\n  /* -------------------------------------------------------------------------------------------------------------------------------------- */\r\n  /*                                                             HÓA ĐƠN ĐIỆN TỬ                                                            */\r\n  /* -------------------------------------------------------------------------------------------------------------------------------------- */\r\n\r\n\r\n\r\n  /**\r\n   * @example\r\n   * this.vhQueryCafe.changeBill_byLocal_toInvoice_byMinvoice(id_bill,invoiceSeries)       \r\n    .then((rsp)=>{    \r\n      //-----------your code here-----------                      \r\n    },(error:any)=>{\r\n        console.log('error', error)\r\n    })\r\n    * @param id_bill \r\n    * @param invoiceSeries   \r\n    * @returns Promise => {vcode, msg, data(array)}\r\n    */\r\n  public changeBill_byLocal_toInvoice_byMinvoice(id_bill: string, invoiceSeries: string): Promise<any> {\r\n\r\n    /** Hàng khuyến mãi được phép xuất 0đ. Nếu là true thì tchat2 sẽ có các cột = 0, ma_thue vẫn là số bình thường */\r\n    const cqt_vat_ecommerce_allow_promotional_items_zero_price = this.vhQueryCafe.getLocalAppSettingNameBranch('permission_branch').cqt_vat_ecommerce_allow_promotional_items_zero_price;\r\n    /** Xuất riêng chiết khấu/giảm giá của sản phẩm thành 1 dòng riêng khi gửi CQT */\r\n    const cqt_vat_ecommerce_separate_discount_line = this.vhQueryCafe.getLocalAppSettingNameBranch('permission_branch').cqt_vat_ecommerce_separate_discount_line;\r\n    /** Vẫn giữ hàng xuất bán cho sản phẩm tặng/khuyến mãi khi gửi CQT */\r\n    const cqt_vat_ecommerce_keep_promotional_items_as_sold = this.vhQueryCafe.getLocalAppSettingNameBranch('permission_branch').cqt_vat_ecommerce_keep_promotional_items_as_sold;\r\n    /** Mã sản phẩm khi gửi CQT là mã vạch sản phẩm */\r\n    const cqt_vat_ecommerce_item_code_is_barcode = this.vhQueryCafe.getLocalAppSettingNameBranch('permission_branch').cqt_vat_ecommerce_item_code_is_barcode;\r\n    /** Giá hàng hóa, dịch vụ... gửi CQT là giá bán đã giảm */\r\n    const cqt_vat_ecommerce_item_price_is_discounted = this.vhQueryCafe.getLocalAppSettingNameBranch('permission_branch').cqt_vat_ecommerce_item_price_is_discounted;\r\n\r\n    return new Promise<any>((resolve, reject) => {\r\n      (async () => {\r\n        try {\r\n          let invoices = new Array();\r\n          // Khởi tạo mảng Promise\r\n          const promises = [\r\n            this.vhQueryCafe.getBill(id_bill),\r\n            this.vhQueryCafe.getBill_details_byId_bill(id_bill)\r\n          ];\r\n          // Sử dụng await để lấy kết quả từ Promise.all()\r\n          const [bill, bill_details] = await Promise.all(promises).catch((err) => {\r\n            console.error('❌ Lỗi trong quá trình lấy dữ liệu:', err);\r\n            throw new Error('Không thể lấy dữ liệu hóa đơn');\r\n          }) as [any, any[]];\r\n\r\n          console.log('bill', bill);\r\n          console.log('bill_details', bill_details);\r\n\r\n          \r\n\r\n          /* ---------------------------------------------------------- Khởi tạo invoice ---------------------------------------------------------- */\r\n\r\n          let invoice: any = {\r\n            inv_invoiceSeries: invoiceSeries,\r\n            inv_invoiceIssuedDate: this.vhAlgorithm.formatDateToString(new Date()),\r\n            inv_currencyCode: \"VND\",\r\n            inv_exchangeRate: 1,\r\n\r\n            inv_paymentMethodName: bill.payment_type == 1 ? \"Tiền mặt\" : \"Chuyển khoản\",\r\n\r\n            inv_buyerDisplayName: bill.tax_buyerDisplayName,\r\n            inv_buyerLegalName: bill.tax_buyerLegalName,\r\n            inv_buyerTaxCode: bill.tax_buyerTaxCode,\r\n            inv_buyerAddressLine: bill.tax_buyerAddressLine,\r\n\r\n            inv_discountAmount: 0, // Tổng tiền chiết khấu (tổng của cột Tiền chiết khấu)\r\n            inv_TotalAmountWithoutVat: 0, // Cộng tiền hàng (Đã trừ CK) Chưa bao gồm VAT (cột Thành tiền trước thuế, = +tchat1 -tchat3 bỏ qua tchat2)\r\n            inv_vatAmount: 0, // Tiền thuế GTGT (= Cộng tiền hàng (Đã trừ CK) Chưa bao gồm VAT * bill.tax / 100)\r\n            inv_TotalAmount: 0, // Tổng cộng tiền thanh toán (sau thuế) (= Cộng tiền hàng (Đã trừ CK) Chưa bao gồm VAT + Tiền thuế GTGT) tương đương trườnG payment của mình\r\n\r\n            key_api: id_bill,\r\n            so_benh_an: bill.bill_code\r\n          }\r\n\r\n\r\n\r\n          /* ------------------------------------------------------ Tính toán invoice details ----------------------------------------------------- */\r\n          \r\n          /** Danh sách bill details */\r\n          var invoice_details = new Array();\r\n\r\n          /* ------------------------------------------------------ Lặp qua các bill details ------------------------------------------------------ */\r\n          for (let i = 0; i < bill_details.length; i++) {\r\n            // Bắt tường hợp CÓ Chương trình khuyến mãi\r\n            /** Danh sách sản phẩm của đơn */\r\n            let products = bill_details[i].products_gift || bill_details[i].products || [bill_details[i]];\r\n\r\n            /* --------------------------------- Xử lý phân tách sản phẩm trong combo thành danh sách từng sản phẩm --------------------------------- */\r\n            /** Mảng chứa danh sách sản phẩm trong combo */\r\n            let productsCombo = [];\r\n            for (let j = 0; j < products.length; j++) {\r\n              // check xem có sản phẩm ptype: 5 (combo)\r\n              if (products[j].ptype === VhType.COMBO && products[j].combos && products[j].combos.length > 0) {\r\n                /** % Giảm giá. Bắt thêm trường hợp price_origin = 0 */\r\n                const percentDiscount = products[j].price_origin > 0 \r\n                  ? (products[j].price_origin - products[j].price) / products[j].price_origin \r\n                  : 0;\r\n                // Nếu có thì lấy tất cả sản phẩm trong combo\r\n                const productInCombo = products[j].combos.map(combo => {\r\n                  return {\r\n                    ...combo,\r\n                    price_origin: this.vhQueryCafe.getUnit_byRatio(combo.units, combo.ratio)?.price,\r\n                    price: combo.price * (1 - percentDiscount),\r\n                  };\r\n                })\r\n                // Thêm danh sách sản phẩm vào mảng\r\n                productsCombo = productsCombo.concat(productInCombo);\r\n                // Xóa sản phẩm combo khỏi danh sách products\r\n                products.splice(j, 1);\r\n                j--; // Giảm j để không bỏ qua sản phẩm tiếp theo\r\n              }\r\n            }\r\n\r\n            // Nếu có sản phẩm combo thì thêm vào danh sách products\r\n            if (productsCombo.length > 0) {\r\n              products = products.concat(productsCombo);\r\n            }\r\n\r\n            // Lăp qua danh sách sản phẩm\r\n            for (let j = 0; j < products.length; j++) {\r\n              let id_sub_or_product = products[j].id_subproduct ? products[j].id_subproduct : products[j].id_product;\r\n              let product: any = await this.vhQueryCafe.getlocalDetailProduct(id_sub_or_product);\r\n\r\n              // Trường hợp giá bán > giá gốc\r\n              if(products[j].price > products[j].price_origin) {\r\n                products[j].price_origin = products[j].price;\r\n              }\r\n\r\n              /** Đơn vị của sản phẩm, bắt trường hợp Dịch vụ thời gian thì thêm Dịch */\r\n              let unitCodeValue = this.vhQueryCafe.getUnit_byRatio(product.units, products[j].ratio)?.unit;\r\n              const serviceTimeUnitMap = {\r\n                'day': 'Ngày',\r\n                'hour': 'Giờ',\r\n                'minute': 'Phút',\r\n                'second': 'Giây'\r\n              }\r\n              if(product.type === VhType.SERVICETIME) unitCodeValue = serviceTimeUnitMap[unitCodeValue] || unitCodeValue;\r\n\r\n              /** Tính chất hàng hóa, nếu giá bán = 0 thì là hàng khuyến mại, ngược lại là hàng hóa dịch vụ */\r\n              const tchat = products[j].price == 0 ? 2 : 1;\r\n\r\n              // Khởi tạo chi tiết hóa đơn\r\n              let invoice_detail = this.createEInvoiceDetailTemplate();\r\n\r\n              // Gán các giá trị chung\r\n              invoice_detail.tchat = tchat;\r\n              invoice_detail.stt_rec0 = invoice_details.length + 1;\r\n              invoice_detail.inv_unitCode = unitCodeValue;\r\n              invoice_detail.inv_quantity = products[j].quantity;\r\n              invoice_detail.inv_unitPrice = products[j].price_origin; // (Đơn giá)\r\n              invoice_detail.ma_thue = bill.tax; // % thuế\r\n\r\n\r\n              /* ------ Xử lý cqt_vat_ecommerce_item_code_is_barcode ------------------------------------------ */\r\n              if(cqt_vat_ecommerce_item_code_is_barcode) {\r\n                const barcode = this.vhQueryCafe.getUnit_byRatio(product.units, products[j].ratio)?.barcode;\r\n                // Nếu có barcode thì dùng barcode\r\n                if(barcode) {\r\n                  invoice_detail.inv_itemCode = barcode;\r\n                }\r\n                // Nếu không có barcode thì thông báo\r\n                else {\r\n                  this.vhComponent.alertMessageDesktop(\"error\", this.languageService.translate(\"Gửi hóa đơn lên CQT thất bại. Hóa đơn có chứa sản phẩm chưa có mã vạch, vui lòng bổ sung và thử lại. Hoặc bỏ chọn cấu hình Mã sản phẩm khi xuất hóa đơn là mã vạch để tiếp tục\"), 5000);\r\n                  reject(new Error('Gửi hóa đơn lên CQT thất bại. Hóa đơn có chứa sản phẩm chưa có mã vạch, vui lòng bổ sung và thử lại. Hoặc bỏ chọn cấu hình Mã sản phẩm khi xuất hóa đơn là mã vạch để tiếp tục'));\r\n                }\r\n              }\r\n              else {\r\n                invoice_detail.inv_itemCode = products[j]._id || products[j].id_product;\r\n              }\r\n\r\n\r\n              /* ------ Xử lý tchat --------------------------------------------------------------------------- */\r\n              if (tchat === 2) {\r\n                // Gán lại tên\r\n                invoice_detail.inv_itemName = 'Hàng khuyến mãi/hàng tặng ' + product.name;\r\n                // Tính lại giá trị trợ giá (chiết khấu) của chi tiết hóa đơn trường hợp tchat2\r\n                invoice_detail.inv_discountAmount = 0;\r\n                // Trợ giá (chiết khấu) tính theo %\r\n                invoice_detail.inv_discountPercentage = 0;\r\n\r\n                /* ------ Xử lý Hàng khuyến mãi được phép xuất 0đ ----------------------------------------------- */\r\n                // Nếu có bật cqt_vat_ecommerce_allow_promotional_items_zero_price và là tchat2 thì cần gán lại giá = 0, để các phép tính cho những trường khác bên dưới cũng sẽ tự tính = 0\r\n                if(cqt_vat_ecommerce_allow_promotional_items_zero_price) {\r\n                  invoice_detail.inv_unitPrice = 0;\r\n                }\r\n\r\n                /* ------ Xử lý Vẫn giữ hàng xuất bán cho sản phẩm tặng/khuyến mãi khi gửi CQT ------------------ */\r\n                // Nếu có bật cqt_vat_ecommerce_keep_promotional_items_as_sold và là tchat2 thì sẽ set lại nso thành tchat1, discountAmount và discountPercentage vẫn là 0\r\n                if(cqt_vat_ecommerce_keep_promotional_items_as_sold) {\r\n                  // Gán lại tchat\r\n                  invoice_detail.tchat = 1; // Gán lại tchat thành 1\r\n                  // Gán lại tên\r\n                  invoice_detail.inv_itemName = product.name;\r\n                }\r\n              }\r\n              else {\r\n                // Gán lại tên\r\n                invoice_detail.inv_itemName = product.name;\r\n                // Trợ giá (chiết khấu) của nhà bán hàng trên mỗi chi tiết hóa đơn = seller_discount + shopee_discount\r\n                invoice_detail.inv_discountAmount = this.roundTo4Decimal((invoice_detail.inv_unitPrice - products[j].price) * invoice_detail.inv_quantity);\r\n\r\n                /* ------ Xử lý Giá hàng hóa, dịch vụ... gửi CQT là giá bán đã giảm ----------------------------------------- */\r\n                if(cqt_vat_ecommerce_item_price_is_discounted) {\r\n                  // Gán lại thành giá đã giảm\r\n                  invoice_detail.inv_unitPrice = invoice_detail.inv_unitPrice - invoice_detail.inv_discountAmount / invoice_detail.inv_quantity;\r\n                  // Gán lại Chiết khấu = 0\r\n                  invoice_detail.inv_discountAmount = 0;\r\n                }\r\n\r\n                // Trợ giá (chiết khấu) tính theo %\r\n                invoice_detail.inv_discountPercentage = (invoice_detail.inv_unitPrice - products[j].price) / invoice_detail.inv_unitPrice * 100;\r\n              }\r\n\r\n              // Giá cuối (đã trừ trợ giá) của chi tiết hóa đơn\r\n              invoice_detail.inv_TotalAmountWithoutVat = this.roundTo4Decimal(invoice_detail.inv_unitPrice * invoice_detail.inv_quantity - invoice_detail.inv_discountAmount);\r\n              //Thuế VAT được tính theo chi tiết hóa đơn\r\n              invoice_detail.inv_vatAmount = this.roundTo4Decimal(invoice_detail.inv_TotalAmountWithoutVat * invoice_detail.ma_thue / 100);\r\n              //Tổng giá trị hàng hóa kê khai theo chi tiết hóa đơn\r\n              invoice_detail.inv_TotalAmount = invoice_detail.inv_TotalAmountWithoutVat + invoice_detail.inv_vatAmount;\r\n\r\n              // Thêm vào mảng\r\n              invoice_details = this.addEInvoiceDetail(invoice_detail, invoice_details, {cqt_vat_ecommerce_separate_discount_line: cqt_vat_ecommerce_separate_discount_line});\r\n            }\r\n          }\r\n\r\n\r\n\r\n          /* -------------------------------------------------------------- Xử lý Phí ------------------------------------------------------------- */\r\n\r\n          // Xử lý cho phí\r\n          // Nếu fee > 0 thì thêm 1 invoice detail cho phí\r\n          if(bill.fee > 0) {\r\n            // Khởi tạo chi tiết hóa đơn\r\n            let invoice_detail = this.createEInvoiceDetailTemplate();\r\n            \r\n            // Gán các giá trị chung\r\n            invoice_detail.tchat = 1;\r\n            invoice_detail.stt_rec0 = invoice_details.length + 1;\r\n            invoice_detail.inv_itemCode = 'phi_phu_thu';\r\n            invoice_detail.inv_itemName = 'Phụ thu';\r\n            invoice_detail.inv_unitCode = 'Lần';\r\n            invoice_detail.inv_quantity = 1;\r\n            invoice_detail.inv_unitPrice = bill.fee;\r\n            invoice_detail.inv_TotalAmountWithoutVat = this.roundTo4Decimal(bill.fee); // Thành tiền trước thuế\r\n            invoice_detail.ma_thue = bill.tax; // % thuế\r\n\r\n            // Thuế VAT được tính theo chi tiết hóa đơn\r\n            invoice_detail.inv_vatAmount = invoice_detail.inv_unitPrice * (invoice_detail.ma_thue / 100);\r\n            // Tổng giá trị hàng hóa kê khai theo chi tiết hóa đơn\r\n            invoice_detail.inv_TotalAmount = invoice_detail.inv_TotalAmountWithoutVat + invoice_detail.inv_vatAmount;\r\n\r\n            // Thêm vào mảng\r\n            invoice_details = this.addEInvoiceDetail(invoice_detail, invoice_details, {cqt_vat_ecommerce_separate_discount_line: cqt_vat_ecommerce_separate_discount_line});\r\n          }\r\n\r\n\r\n\r\n          /* ----------------------------------------------------------- Xử lý giảm giá ----------------------------------------------------------- */\r\n\r\n          // Xử lý phần giảm giá (Giảm giá + Chiết khấu + Thanh toán điểm + Thanh toán phiếu)\r\n          // tạo thành 1 invoice detail cso tchat3 cho phần giảm giá\r\n          // invoice này vẫn sẽ tính thuế, nhưng khi tính tổng thuế sẽ bỏ qua nó (tương đương bill.total * (bill.tax / 100) của mình)\r\n          if((bill.payment_points ?? 0) > 0 || (bill.payment_coupons ?? 0) > 0 || (bill.discount_bill ?? 0) > 0 || (bill.discount ?? 0) > 0) {\r\n            /** Tổng tiền giảm giá (Tổng tiền chiết khấu) */\r\n            const totalDiscountAmount = (bill.payment_points ?? 0) + (bill.payment_coupons ?? 0) + (bill.discount_bill ?? 0) + (bill.discount ?? 0);\r\n            /** Tiền thuế */\r\n            const vatAmount = totalDiscountAmount * (bill.tax / 100);\r\n\r\n            // Khởi tạo chi tiết hóa đơn\r\n            let invoice_detail = this.createEInvoiceDetailTemplate();\r\n            \r\n            // Gán các giá trị chung\r\n            invoice_detail.tchat = 3;\r\n            invoice_detail.stt_rec0 = invoice_details.length + 1;\r\n            invoice_detail.inv_itemCode = 'chiet_khau_thuong_mai';\r\n            invoice_detail.inv_itemName = 'Chiết khấu thương mại';\r\n            invoice_detail.inv_unitCode = 'Phần';\r\n            invoice_detail.inv_quantity = 1;\r\n            invoice_detail.inv_unitPrice = totalDiscountAmount;\r\n            invoice_detail.inv_TotalAmountWithoutVat = this.roundTo4Decimal(totalDiscountAmount); // Thành tiền trước thuế\r\n            invoice_detail.ma_thue = bill.tax; // % thuế\r\n            invoice_detail.inv_vatAmount = this.roundTo4Decimal(vatAmount); // tiền thuế (Tiền thuế GTGT)\r\n            invoice_detail.inv_TotalAmount = this.roundTo4Decimal(totalDiscountAmount + vatAmount); // tổng tiền sau thuế (Thành tiền sau thuế)\r\n\r\n            // Thêm vào mảng\r\n            invoice_details = this.addEInvoiceDetail(invoice_detail, invoice_details, {cqt_vat_ecommerce_separate_discount_line: cqt_vat_ecommerce_separate_discount_line});\r\n          }\r\n\r\n\r\n\r\n          /* ---------------------------------------------- Gán lại các trường tính toán cho invoice ---------------------------------------------- */\r\n\r\n          for (let i = 0; i < invoice_details.length; i++) {\r\n            if (invoice_details[i].tchat == 1) {\r\n              // tchat 1 thì cộng dồn\r\n              invoice.inv_discountAmount += invoice_details[i].inv_discountAmount;\r\n              invoice.inv_vatAmount += invoice_details[i].inv_vatAmount;\r\n              invoice.inv_TotalAmountWithoutVat += invoice_details[i].inv_TotalAmountWithoutVat;\r\n              invoice.inv_TotalAmount += invoice_details[i].inv_TotalAmount;\r\n            } else if (invoice_details[i].tchat == 2) {\r\n              // tchat 2 thì bỏ qua\r\n            } else if (invoice_details[i].tchat == 3) {\r\n              // tchat 3 thì phải trừ lại\r\n              invoice.inv_discountAmount -= invoice_details[i].inv_discountAmount;\r\n              invoice.inv_vatAmount -= invoice_details[i].inv_vatAmount;\r\n              invoice.inv_TotalAmountWithoutVat -= invoice_details[i].inv_TotalAmountWithoutVat;\r\n              invoice.inv_TotalAmount -= invoice_details[i].inv_TotalAmount;\r\n            }\r\n          }\r\n\r\n\r\n          /* ----------------------------------------------------------- Trả về giá trị ----------------------------------------------------------- */\r\n\r\n          invoices = [{ ...invoice, details: [{ data: invoice_details }] }];\r\n          console.log('data', invoices);\r\n          resolve({ vcode: 0, msg: 'success', data: invoices });\r\n        } catch (err) {\r\n          console.error('❌ Lỗi saveInvoice_noSign_byMinvoice:', err);\r\n          reject(err);\r\n        }\r\n      })()\r\n    })\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Công thức tính giá mới của sản phẩm (newPrice) để total sau khi áp thuế (thuế từ phần cài đặt của app mình) không thay đổi\r\n   *\r\n   * ((gia * sl - ck) / (1 + thue_cai_dat) + ck) / sl\r\n   * \r\n   * @param unitPrice Giá cũ\r\n   * @param quantity Số lượng sản phẩm\r\n   * @param discountAmount Tiền chiết khấu\r\n   * @param taxSetting Thuế từ phần cài đặt của app mình (ví dụ 20% thì truyền vào: 20)\r\n   * @param taxPlatform Thuế từ sàn (ví dụ 10% thì truyền vào: 10)\r\n   * \r\n   * @returns Giá mới của sản phẩm (newPrice) để total sau khi áp thuế không thay đổi\r\n   *\r\n   * @example\r\n   *\r\n    Tính giá mới của sản phẩm (newPrice) để total sau khi áp thuế (thuế từ phần cài đặt của app mình) không thay đổi\r\n\r\n    vd: sl = 2, gia = 15000, ck = 5000, thue_san = 50%\r\n    => total = ((gia * sl) - ck) * (1 + thue_san)\r\n    => total = ((15000 * 2) - 5000) * (1 + 0.5)\r\n    => total = 37500\r\n\r\n    thue_cai_dat = 20% (thuế từ phần cài đặt của app mình)\r\n    total = ((newPrice * sl - ck)) * (1 + thue_cai_dat)\r\n    => newPrice = (total / (1 + thue_cai_dat) + ck) / sl   hoặc   ((((gia * sl) - ck) * (1 + thue_san)) / (1 + thue_cai_dat) + ck) / sl\r\n    => newPrice = (37500 / (1 + 0.2) + 5000) / 2\r\n    => newPrice = 18125\r\n\r\n    thay 18125 vào công thức tính total với thuế cài đặt (sẽ bỏ qua thuế sàn)\r\n    => total = ((gia * sl) - ck) * (1 + thue_cai_dat)\r\n    => total = ((18125 * 2) - 5000) * (1 + 0.2)\r\n    => total = 37500\r\n    => total vẫn là 37500 không thay đổi\r\n\r\n\r\n    Công thức tính ngược lại giá cảu sản phẩm:\r\n    unitPrice = ((((newPrice * quantity - discountAmount) * (1 + taxSetting / 100)) / (1 + taxPlatform / 100)) + discountAmount) / quantity\r\n\r\n\r\n    Sử dụng:\r\n\r\n    invoice_detail.inv_unitPrice = calculateNewPrice(invoice_detail.inv_unitPrice, invoice_detail.inv_quantity, invoice_detail.inv_discountAmount, invoice_detail.ma_thue, platformTax);\r\n    \r\n    */\r\n  calculateNewPriceToUseSettingTax(unitPrice, quantity, discountAmount, taxSetting, taxPlatform): number {\r\n    return (((unitPrice * quantity - discountAmount) * (1 + taxPlatform / 100)) / (1 + taxSetting / 100) + discountAmount) / quantity;\r\n  }\r\n\r\n\r\n\r\n  /** \r\n   * Làm tròn 4 chữ số thập phân. VD: 123.456789 => 123.4568; 123.45671 => 123.4567\r\n   * \r\n   * @param num Số cần làm tròn\r\n   * \r\n   * @return Số đã làm tròn đến 4 chữ số thập phân\r\n   * \r\n   * @example\r\n   * this.roundTo4Decimal(123.456789); // 123.4568\r\n   */\r\n  roundTo4Decimal(num: any): number {\r\n    return parseFloat(num.toFixed(4));\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Khởi tạo một object chi tiết hoá đơn điện tử với các trường mặc định.\r\n   * tchat = 1, các trường số thì mặc định là 0, các trường chuỗi thì mặc định là rỗng.\r\n   * @returns object mặc định\r\n   * @example\r\n   * let invoice_detail = this.billService.createEInvoiceDetailTemplate();\r\n   * \r\n   * Mẫu khởi tạo với các trường mặc định:\r\n    {\r\n      tchat: 1, // Tính chất hàng hóa: Hàng hóa dịch vụ (giá trị tchat là 1); Khuyến mại (giá trị tchat là 2); Chiết khấu thương mại (giá trị tchat là 3); Ghi chú/ diễn giải (giá trị tchat là 4); Hàng hóa đăc trưng (giá trị tchat là 5)\r\n      stt_rec0: 0, // Số thứ tự của sản phẩm trong hóa đơn\r\n      inv_itemCode: '', // Mã sản phẩm\r\n      inv_itemName: '', // Tên sản phẩm, nếu tchatValue là 2 thì thêm chữ \"Hàng khuyến mãi/hàng tặng\" vào trước tên sản phẩm\r\n      inv_unitCode: '', // Đơn vị của sản phẩm\r\n      inv_quantity: 0, // Số lượng sản phẩm\r\n      inv_unitPrice: 0, // Giá gốc bán sản phẩm\r\n      ma_thue: 0, // % thuế\r\n      inv_discountPercentage: 0,\r\n      inv_discountAmount: 0, // Tiền chiết khấu (Giảm giá)\r\n      inv_TotalAmountWithoutVat: 0, // Thành tiền trước thuế\r\n      inv_vatAmount: 0, // thuế (Tiền thuế GTGT)\r\n      inv_TotalAmount: 0 // Thành tiền sau thuế\r\n    };\r\n    */\r\n  createEInvoiceDetailTemplate() {\r\n    return {\r\n      tchat: 1, // Tính chất hàng hóa: Hàng hóa dịch vụ (giá trị tchat là 1); Khuyến mại (giá trị tchat là 2); Chiết khấu thương mại (giá trị tchat là 3); Ghi chú/ diễn giải (giá trị tchat là 4); Hàng hóa đăc trưng (giá trị tchat là 5)\r\n      stt_rec0: 0, // Số thứ tự của sản phẩm trong hóa đơn\r\n      inv_itemCode: '', // Mã sản phẩm\r\n      inv_itemName: '', // Tên sản phẩm, nếu tchatValue là 2 thì thêm chữ \"Hàng khuyến mãi/hàng tặng\" vào trước tên sản phẩm\r\n      inv_unitCode: '', // Đơn vị của sản phẩm\r\n      inv_quantity: 0, // Số lượng sản phẩm\r\n      inv_unitPrice: 0, // Giá gốc bán sản phẩm\r\n      ma_thue: 0, // % thuế\r\n      inv_discountPercentage: 0, // % tiền chiết khấu (Giảm giá). Không thể để 100 vì khi 100% thì là tchat2 rồi\r\n      inv_discountAmount: 0, // Tiền chiết khấu (Giảm giá)\r\n      inv_TotalAmountWithoutVat: 0, // Thành tiền trước thuế\r\n      inv_vatAmount: 0, // thuế (Tiền thuế GTGT)\r\n      inv_TotalAmount: 0 // Thành tiền sau thuế\r\n    };\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Thêm invoice_detail vào invoice_details. Và kiểm tra các setting trong settings\r\n   * \r\n   * `cqt_vat_ecommerce_separate_discount_line` là true và `tchat1` và `inv_discountAmount > 0` thì sẽ tách chiết khấu ra thành một dòng riêng trong invoice_details.\r\n   * \r\n   * @param invoice_detail invoice_detail cần thêm vào invoice_details\r\n   * @param invoice_details Danh sách invoice_details hiện tại \r\n   * @param settings Các cài đặt sẽ kiểm tra \r\n   * @returns Mảng invoice_details sau khi thêm\r\n   */\r\n  addEInvoiceDetail(invoice_detail: any, invoice_details: any[], settings: { cqt_vat_ecommerce_separate_discount_line: boolean }): any[] {\r\n    // Nếu KHÔNG cqt_vat_ecommerce_separate_discount_line hoặc KHÔNG phải tchat1 hoặc inv_discountAmount <= 0 thì thêm thẳng vào invoice_details\r\n    if (!settings.cqt_vat_ecommerce_separate_discount_line || invoice_detail.tchat !== 1 || invoice_detail.inv_discountAmount <= 0) {\r\n      invoice_details.push(invoice_detail);\r\n      return invoice_details;\r\n    }\r\n\r\n\r\n    // NGƯỢC LẠI\r\n    // Sẽ tách ra thành 2 invoice_detail:\r\n    // 1. invoice_detail hiện tại (tchat1) sẽ giữ nguyên các trường như cũ, gán lại inv_discountAmount = 0, inv_discountPercentage = 0, tính lại inv_TotalAmountWithoutVat, inv_vatAmount, inv_TotalAmount\r\n    // 2. invoice_detail mới (tchat3) sẽ set các trường như sau:\r\n    //    - tchat = 3\r\n    //    - stt_rec0 = invoice_details.length + 1\r\n    //    - inv_itemCode = 'giam_gia_cho_' + cloneInvoiceDetail.inv_itemCode\r\n    //    - inv_itemName = 'Giảm giá ' + cloneInvoiceDetail.inv_discountAmount + ' cho ' + cloneInvoiceDetail.inv_itemName\r\n    //    - inv_unitCode = 'Phần'\r\n    //    - inv_quantity = 1\r\n    //    - inv_unitPrice = cloneInvoiceDetail.inv_discountAmount\r\n    //    - ma_thue = cloneInvoiceDetail.ma_thue\r\n    //    - inv_discountPercentage = 0\r\n    //    - inv_discountAmount = 0\r\n    //    - inv_TotalAmountWithoutVat, inv_vatAmount, inv_TotalAmount sẽ được tính lại dựa trên các trường mới này\r\n\r\n\r\n    /* ----- Tạo newInvoiceDetailId mới và gán lại các trường ------------------------------------------ */\r\n    const newInvoiceDetail = this.createEInvoiceDetailTemplate();\r\n    newInvoiceDetail.tchat = 3;\r\n    newInvoiceDetail.stt_rec0 = invoice_details.length + 2; // Cộng 2 là do lát nauwx sẽ chèn invoice_detail này vào sau invoice_detail hiện tại\r\n    newInvoiceDetail.inv_itemCode = 'giam_gia_cho_' + invoice_detail.inv_itemCode;\r\n    newInvoiceDetail.inv_itemName = 'Giảm giá ' + invoice_detail.inv_discountAmount + ' cho ' + invoice_detail.inv_itemName;\r\n    newInvoiceDetail.inv_unitCode = 'Phần';\r\n    newInvoiceDetail.inv_quantity = 1;\r\n    newInvoiceDetail.inv_unitPrice = invoice_detail.inv_discountAmount;\r\n    newInvoiceDetail.ma_thue = invoice_detail.ma_thue;\r\n    newInvoiceDetail.inv_discountPercentage = 0;\r\n    newInvoiceDetail.inv_discountAmount = 0;\r\n    newInvoiceDetail.inv_TotalAmountWithoutVat = newInvoiceDetail.inv_unitPrice * newInvoiceDetail.inv_quantity - newInvoiceDetail.inv_discountAmount;\r\n    newInvoiceDetail.inv_vatAmount = newInvoiceDetail.inv_TotalAmountWithoutVat * newInvoiceDetail.ma_thue / 100;\r\n    newInvoiceDetail.inv_TotalAmount = newInvoiceDetail.inv_TotalAmountWithoutVat + newInvoiceDetail.inv_vatAmount\r\n\r\n\r\n    /* ----- Xử lý invoice_detail hiện tại --------------------------------------------------- */\r\n    invoice_detail.inv_discountAmount = 0;\r\n    invoice_detail.inv_discountPercentage = 0;\r\n    invoice_detail.inv_TotalAmountWithoutVat = invoice_detail.inv_unitPrice * invoice_detail.inv_quantity - invoice_detail.inv_discountAmount; // Tính lại sau khi gán lại inv_discountAmount\r\n    invoice_detail.inv_vatAmount = invoice_detail.inv_TotalAmountWithoutVat * invoice_detail.ma_thue / 100; // Tính lại sau khi gán lại inv_discountAmount\r\n    invoice_detail.inv_TotalAmount = invoice_detail.inv_TotalAmountWithoutVat + invoice_detail.inv_vatAmount; // Tính lại sau khi gán lại inv_discountAmount\r\n    \r\n\r\n    /* ----- Thêm vào mảng ----------------------------------------------------------- */\r\n    // Thêm invoice_detail đã xử lý vào invoice_details\r\n    invoice_details.push(invoice_detail);\r\n    // Thêm newInvoiceDetail vào invoice_details\r\n    invoice_details.push(newInvoiceDetail);\r\n\r\n    // Trả về mảng invoice_details đã thêm mới\r\n    return invoice_details;\r\n  }\r\n\r\n}\r\n"],"names":["VhType","BillService","constructor","languageService","vhQueryCafe","vhAuth","vhAlgorithm","vhComponent","nzMessageService","router","getlocalTaxs","filter","tax","status","getPaymentName","payment_type","id_wallet","translate","getlocalWallet","_a","name","getEarningPointBill","program_bill","selectedBill","subTotal","billDetails","bill_total_minimum","sub","include_promotion_product","getSubTotalNotPromotion","include_discount","getDiscount","getDiscountBill","include_paid_points","getDiscountPoint","include_fee","getFee","include_tax","getTax","exchange","money","points","item","id_promotion","reduce","prev","next","quantity","price","getTotalEarningPointProduct","product","promotion","program_product","products","find","i","_id","getSubTotalNotPromotionOfProduct","products_of_program_earnig_product","price_origin","id_product","id_subproduct","getTotalEarningPoint","earning_point","getEarningPointAllProduct","createBill","selectedAreaID","selectedTableID","searchValueAreaGoHome","indexTabArea","filterType","dataRestore","indexTab","searchValue","id_area","warning","showLoading","then","createBill_Billdetail","date","Date","toISOString","id_customer","tax_buyerDisplayName","tax_buyerLegalName","tax_buyerTaxCode","tax_buyerAddressLine","tax_buyerEmail","id_table","id_branch","getDefaultBranch","id_employee","getUser","total","payment","discount","fee","bill_type","note","cash","bill","Promise","all","updateTable","hideLoading","navigate","state","id_bill","error","console","log","saveBill","getIdTable","saveBill_Billdetail","getID","getBillsGoHome","getBills_byFields","$eq","bills","map","customerName","getlocalCustomer","customerPhone","_b","phone","employeeName","getlocalEmployee","_c","paymentName","catch","err","searchBillGoHome","value","billsGoHome","fields","searchFields","length","val","changeAlias","trim","toLowerCase","searchList","getBillDetailsByIdBill","resolve","reject","getBill_details_byId_bill","invoiceDetails","invoiceDetailsFresh","toppings","element","getlocalDetailProduct","combos","changeBill_byLocal_toInvoice_byMinvoice","invoiceSeries","cqt_vat_ecommerce_allow_promotional_items_zero_price","getLocalAppSettingNameBranch","cqt_vat_ecommerce_separate_discount_line","cqt_vat_ecommerce_keep_promotional_items_as_sold","cqt_vat_ecommerce_item_code_is_barcode","cqt_vat_ecommerce_item_price_is_discounted","invoices","Array","promises","getBill","bill_details","Error","invoice","inv_invoiceSeries","inv_invoiceIssuedDate","formatDateToString","inv_currencyCode","inv_exchangeRate","inv_paymentMethodName","inv_buyerDisplayName","inv_buyerLegalName","inv_buyerTaxCode","inv_buyerAddressLine","inv_discountAmount","inv_TotalAmountWithoutVat","inv_vatAmount","inv_TotalAmount","key_api","so_benh_an","bill_code","invoice_details","products_gift","productsCombo","j","ptype","COMBO","percentDiscount","productInCombo","combo","getUnit_byRatio","units","ratio","concat","splice","id_sub_or_product","unitCodeValue","unit","serviceTimeUnitMap","type","SERVICETIME","tchat","invoice_detail","createEInvoiceDetailTemplate","stt_rec0","inv_unitCode","inv_quantity","inv_unitPrice","ma_thue","barcode","inv_itemCode","alertMessageDesktop","inv_itemName","inv_discountPercentage","roundTo4Decimal","addEInvoiceDetail","payment_points","payment_coupons","_d","discount_bill","_e","_f","totalDiscountAmount","_g","_h","_j","_k","vatAmount","details","data","vcode","msg","calculateNewPriceToUseSettingTax","unitPrice","discountAmount","taxSetting","taxPlatform","num","parseFloat","toFixed","settings","push","newInvoiceDetail","i0","factory","providedIn"],"sourceRoot":"webpack:///"}