{"version":3,"file":"default-src_app_sales_services_bill_service_ts.js","mappings":"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","sources":["./src/app/sales/services/bill.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { LanguageService } from './language.service';\r\nimport { VhAlgorithm, VhAuth, VhEcommerce, VhQuerySales } from 'ionic-vhframeworks';\r\nimport { VhSaleDesktopInvoiceDetailCombo, VhSaleInvoiceDetailAdd, VhSaleInvoiceDetailEdit, VhSaleInvoiceEdit } from '../components/bill-type/bill-type-1/sales-desktop/sales-desktop-interface';\r\nimport { VhComponent } from '../components/vh-component/vh-component';\r\nimport { VhType } from '../interface/vh-type';\r\n\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class BillService {\r\n\r\n  /** Danh sách thuế */\r\n  listTax: any = this.vhQuerySales.getlocalTaxs().filter(item => item.status);\r\n\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private vhQuerySales: VhQuerySales,\r\n    public vhAuth: VhAuth,\r\n    public vhAlgorithm: VhAlgorithm,\r\n    private vhComponent: VhComponent,\r\n    private vhEcommerce: VhEcommerce,\r\n  ) {}\r\n\r\n\r\n\r\n  /**\r\n   * Tính subtotal của hóa đơn\r\n   * @param billDetails Danh sách billDetails của hóa đơn cần tính\r\n   * @returns Subtotal của hóa đơn\r\n   */\r\n  getSubTotal(billDetails: any): number {\r\n    let subTotal = 0;\r\n    for (let i of billDetails) {\r\n      let total_product_gift = 0;\r\n      let total_products = 0;\r\n      if (i.products_gift) {\r\n        total_product_gift = i.products_gift.filter(item => item.choose).reduce((prev: number, next) => prev + next.quantity * next.price, 0);\r\n      }\r\n      else if (i.products) {\r\n        total_products = i.products.reduce((prev: number, next) => prev + next.quantity * next.price, 0);\r\n      }\r\n      subTotal += total_products + total_product_gift + (i.price ? i.price * i.quantity : 0);\r\n    }\r\n    return subTotal;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Trả về điểm được tích của sản phẩm được thêm.\r\n   * @param product sản phẩm được thêm\r\n   * @param promotion Khuyến mãi áp dụng\r\n   * @param program_product Chương trình tích điểm\r\n   * @returns 0 | number\r\n   */\r\n  getTotalEarningPointProduct(product, promotion, program_product): number {\r\n    if (program_product) {\r\n      let subTotal = 0;\r\n      if (!program_product.include_promotion_product && promotion) { // tích điểm sp có km =>  tính lại subTotal\r\n        subTotal = program_product.products.find(i => i == product._id) ? product.price : 0;\r\n        return ((subTotal - subTotal % program_product.exchange.money) / program_product.exchange.money) * program_product.exchange.points;\r\n      }\r\n      else {\r\n        subTotal = program_product.products.find(i => i == product._id) ? product.price : 0;\r\n        return ((subTotal - subTotal % program_product.exchange.money) / program_product.exchange.money) * program_product.exchange.points;\r\n      }\r\n    }\r\n    else return 0;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Tính tổng tiền của bill\r\n   * @returns Tổng tiền của bill \r\n   */\r\n  getTotal(subTotal: number, bill): number {\r\n    const total = subTotal \r\n      - bill.discount \r\n      - bill.discount_bill \r\n      - bill.payment_coupons\r\n      - bill.payment_points\r\n      + bill.fee;\r\n\r\n    return total > 0 ? total : 0;\r\n  }\r\n\r\n\r\n  \r\n  /**\r\n   * Tính giá trị thuế ra tiền\r\n   * @param bill Hóa đơn cần tính \r\n   * @returns Giá trị thuế \r\n   */\r\n  getTax(bill: any): number {\r\n    return bill.total * (bill.tax / 100);\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Trả về tên của phương thức thanh toán\r\n   * @param payment_type Loại thanh toán \r\n   * @param id_wallet \r\n   * @returns 1: Tiền mặt, 2: Thẻ, 3: Ví\r\n   */\r\n  getPaymentName(payment_type: 1 | 2 | 3, id_wallet: string = null) {\r\n    switch (payment_type) {\r\n      case 1: return this.languageService.translate('Cash');\r\n      case 2: return this.languageService.translate('Debit');\r\n      case 3: return this.vhQuerySales.getlocalWallet(id_wallet)?.name;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Lấy hoá đơn trong ngày. Với bill_type = 5 (hoá đơn bán hàng).\r\n   * @returns Mảng danh sách hoá đơn trong ngày.\r\n   * @example\r\n   * this.invoiceService.getBillsToday().then((bills: VhSaleInvoiceEdit[]) => {\r\n   *  console.log(bills);\r\n   * });\r\n   */\r\n  getBillsToday(): Promise<VhSaleInvoiceEdit[]> {\r\n    return this.vhQuerySales.getBills_byFields(\r\n      {\r\n        bill_type: { $eq: 5 },\r\n        id_branch: { $eq: this.vhQuerySales.getDefaultBranch()._id },\r\n        id_employee: { $eq: this.vhAuth.getUser()._id }, \r\n        id_shop: { $eq: 'local' }\r\n      },\r\n      {}\r\n    ) as Promise<VhSaleInvoiceEdit[]>;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Trả về dữ liệu chuẩn của bill_detail để lưu DB\r\n   * @param item bill_detail cần lưu\r\n   * @returns dữ liệu chuẩn của bill_detail\r\n   * @example let bill_detail = this.getCleanBillDetail({object product});\r\n   */\r\n  getCleanBillDetail(item) {\r\n    let detail: VhSaleInvoiceDetailAdd = {\r\n      id_product: item.id_product,\r\n      ptype: item.ptype,\r\n      price: item.price,\r\n      price_origin: item.price_origin,\r\n      quantity: item.quantity,\r\n      earning_points_product: item.earning_points_product,\r\n      ratio: item.ratio,\r\n    };\r\n    if (item.id_lotproduct) detail['id_lotproduct'] = item.id_lotproduct;\r\n    if (item.id_subproduct) detail['id_subproduct'] = item.id_subproduct;\r\n\r\n    if (item.ptype == 5) {\r\n      detail['combos'] = item.combos.map(combo => {\r\n        let product: VhSaleDesktopInvoiceDetailCombo = {\r\n          id_product: combo.id_product,\r\n          price: combo.price,\r\n          quantity: combo.quantity,\r\n          ptype: combo.ptype,\r\n          ratio: combo.ratio ? combo.ratio : 1,\r\n        };\r\n        if (combo.id_lotproduct) product['id_lotproduct'] = combo.id_lotproduct;\r\n        if (combo.id_subproduct) product['id_subproduct'] = combo.id_subproduct;\r\n        return product;\r\n      });\r\n    }\r\n    return detail;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Cập nhật bill_detail lên database\r\n   * @param id_bill_detail id của bill_detail cần cập nhật\r\n   * @param data dữ liệu cần cập nhật\r\n   * @param callbackSuccess callback khi cập nhật thành công\r\n   * @param callbackError callback khi cập nhật thất bại\r\n   * @example \r\n   * this.updateBillDetail('id_bill_detail', billDetails);\r\n   * this.updateBillDetail('id_bill_detail', billDetails, () => {console.log('success')}, (error) => {console.log(error)});\r\n   */\r\n  updateBillDetail(id_bill_detail, billDetails, callbackSuccess?, callbackError?) {\r\n    this.vhQuerySales.updateBill_Detail(id_bill_detail, billDetails)\r\n      .then((bool: any) => {\r\n        if(callbackSuccess) callbackSuccess(bool);\r\n      }, error => {\r\n        console.log('error', error);\r\n        if(callbackError) callbackError(error);\r\n      });\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * hàm get điểm tích lũy theo hóa đơn\r\n   * 1. get hạng khách hàng\r\n   * 2. từ hạng khách hàng get tích điểm theo bill\r\n   * 3. check các điều kiện của chương trình \r\n   * a check sản phẩm khuyến mãi include_promotion_product\r\n   * b  check giảm giá/ chiết khấu include_discount\r\n   * c check thanh toán = điểm thưởng include_paid_points\r\n   * d check phí  include_fee \r\n   * e check thuế include_tax\r\n   * @returns 0 | number\r\n   */\r\n  getEarningPointBill(program_bill, selectedBill, subTotal, billDetails): number {\r\n    let sub = subTotal;\r\n    if (program_bill && sub > program_bill.bill_total_minimum) {\r\n      // ko tích điểm sp có km => tính lại sub\r\n      if (!program_bill.include_promotion_product) { \r\n        sub = this.getSubTotalNotPromotion(billDetails);\r\n        if (program_bill.include_discount) {\r\n          sub = sub - selectedBill.discount - selectedBill.discount_bill;\r\n        }\r\n        if (program_bill.include_paid_points && selectedBill.payment_points) {\r\n          sub = sub - selectedBill.payment_points;\r\n        }\r\n        if (program_bill.include_fee) {\r\n          sub += selectedBill.fee;\r\n        }\r\n        if (program_bill.include_tax) {\r\n          sub += sub * (selectedBill.tax / 100);\r\n        }\r\n        return ((sub - sub % program_bill.exchange.money) / program_bill.exchange.money) * program_bill.exchange.points;\r\n      }\r\n      else {\r\n        if (program_bill.include_discount) {\r\n          sub = sub - selectedBill.discount - selectedBill.discount_bill;\r\n        }\r\n        if (program_bill.include_paid_points && selectedBill.payment_points) {\r\n          sub = sub - selectedBill.payment_points;\r\n        }\r\n        if (program_bill.include_fee) {\r\n          sub += selectedBill.fee;\r\n        }\r\n        if (program_bill.include_tax) {\r\n          sub += sub * (selectedBill.tax / 100);\r\n        }\r\n        return ((sub - sub % program_bill.exchange.money) / program_bill.exchange.money) * program_bill.exchange.points;\r\n      }\r\n    }\r\n    else return 0;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n  * Trả về tổng tiền của sản phẩm ko có chương trình khuyến mãi\r\n  * @param billDetails Mảng billDetails cần tính\r\n  * @returns Tổng tiền của sản phẩm ko có chương trình khuyến mãi\r\n  */\r\n  getSubTotalNotPromotion(billDetails) {\r\n    return billDetails.filter(item => !item.id_promotion).reduce((prev: number, next) => prev + next.quantity * next.price, 0)\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * hàm này trả về tổng điểm được tích của tất cả sản phẩm\r\n   * @param program_product chương trình tích điểm sản phẩm\r\n   * @param billDetails mảng billDetails\r\n   * @returns 0 | number\r\n   */\r\n  getEarningPointAllProduct(program_product, billDetails): number {\r\n    if (program_product) {\r\n      let subTotal = 0;\r\n      if (!program_product.include_promotion_product) { // tích điểm sp có km => tính lại subTotal\r\n        subTotal = this.getSubTotalNotPromotionOfProduct(program_product.products, billDetails);\r\n        return ((subTotal - subTotal % program_product.exchange.money) / program_product.exchange.money) * program_product.exchange.points;\r\n      }\r\n      else {\r\n        subTotal = billDetails.filter(item => item.price_origin == item.price && program_product.products\r\n                              .find(i => i == item.id_product))\r\n                              .reduce((prev: number, next) => prev + next.quantity * next.price, 0);\r\n        return ((subTotal - subTotal % program_product.exchange.money) / program_product.exchange.money) * program_product.exchange.points;\r\n      }\r\n    }\r\n    else return 0;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Trả về tổng điểm được tích của hoá đơn và sản phẩm.\r\n   * = Tổng điểm tích được của tất cả sản phẩm + Tổng điểm tích được của hoá đơn\r\n   * @returns 0 | number \r\n   */\r\n  getTotalEarningPoint(program_product, program_bill, subTotal, selectedBill, billDetails): number {\r\n    return this.getEarningPointAllProduct(program_product, billDetails) + this.getEarningPointBill(program_bill, selectedBill, subTotal, billDetails);\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Trả về tổng tiền của sản phẩm ko có chương trình khuyến mãi thuộc chương trình tích điểm sản phẩm\r\n   * @param products_of_program_earnig_product Mảng sản phẩm thuộc chương trình tích điểm sản phẩm\r\n   * @param billDetails Mảng billDetails cần tính\r\n   * @returns Tổng tiền của sản phẩm ko có chương trình khuyến mãi thuộc chương trình tích điểm sản phẩm\r\n   */\r\n  getSubTotalNotPromotionOfProduct(products_of_program_earnig_product, billDetails): number {\r\n    return billDetails\r\n      .filter(item => item.price_origin == item.price && products_of_program_earnig_product.find(i => i == item.id_product || i == item.id_subproduct))\r\n      .reduce((prev: number, next) => prev + next.quantity * next.price, 0)\r\n  }\r\n\r\n  \r\n\r\n  /**\r\n   * Tính lại thanh toán để lưu trường payment của bill\r\n   * @param selectedBill bill đang chọn\r\n   * @param taxValue giá trị thuế\r\n   * @returns thanh toán\r\n   */\r\n  getPayment(selectedBill, taxValue) {\r\n    if (selectedBill.payment_type == 2) {\r\n      return 0;\r\n    } else {\r\n      return selectedBill.total + taxValue;\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Cập nhật lại tiền khách đưa để lưu trường cash trong bill\r\n   * @param selectedBill bill đang chọn\r\n   * @param value giá trị khách đưa\r\n   * @example this.setCash(100000)\r\n   */\r\n  getCash(selectedBill, value) {\r\n    if (selectedBill.payment_type == 2) {\r\n      return 0;\r\n    }\r\n    else {\r\n      if (value) {\r\n        return parseFloat(value);\r\n      }\r\n      else {\r\n        return 0;\r\n      }\r\n    }\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Xoá bill\r\n   * @param index vị trí của bill cần xoá\r\n   * @param id id của bill cần xoá\r\n   * @param selectedIndex vị trí của bill đang chọn\r\n   * @returns Promise<void>\r\n   * @example this.deleteBill(0, 'id_bill', 0).then(() => {console.log('success')}).catch((error) => {console.log(error)});\r\n   */\r\n  deleteBill(index, id, selectedIndex): Promise<void> {\r\n    return new Promise<void>((resolve, reject) => {\r\n      if (this.vhAuth.checkMyPermission('sales_enable_create_bill')) {\r\n        this.vhComponent.alertConfirm(\r\n          `${this.languageService.translate(\"Confirm\")}`,\r\n          \"\",\r\n          `${this.languageService.translate(\"Are you sure to cancel the sales order\")}?`,\r\n          \"OK\",\r\n          this.languageService.translate('Cancel')\r\n        ).then(() => {\r\n          // Nếu cái cần xoá === cái đang chọn thì closeSyncOpeningBill\r\n          if (index == selectedIndex) {\r\n            this.vhQuerySales.closeSyncOpeningBill();\r\n          }\r\n          // Thực hiện xoá\r\n          this.vhComponent.showLoading('').then(() => {\r\n            this.vhQuerySales.deleteBill_Billdetail(id)\r\n              .then(() => {\r\n                resolve();\r\n              }, error => {\r\n                reject(error);\r\n              });\r\n          }).catch((error: any) => {\r\n            reject(error);\r\n          });\r\n        }, (cancel) => {\r\n        });\r\n      } else {\r\n        reject(new Error('Permission denied'));\r\n      }\r\n    });\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Tìm vị trí của sản phẩm trong mảng billDetails\r\n   * @param value Sản phẩm cần tìm index trong bill\r\n   * @param billDetails Mảng billDetails cần tìm\r\n   * @returns Vị trí của sản phẩm trong mảng billDetails\r\n   * @example this.getBillDetailIndex({object product}, billDetails);\r\n   */\r\n  getBillDetailIndex(value, billDetails): number {\r\n    let index = -1;\r\n    if(value.lot_number) {\r\n      index = billDetails.findIndex(detail => detail['lot_number'] == value['lot_number'] && detail['id_lotproduct'] == value['id_lotproduct']);\r\n    }\r\n    else {\r\n      if (value.id_subproduct) {\r\n        index = billDetails.findIndex(detail => detail['id_subproduct'] == value['id_subproduct'] && detail['ratio'] == value['ratio']);\r\n      }\r\n      else {\r\n        index = billDetails.findIndex(detail => detail['id_product'] == value['_id'] && detail['ratio'] == value['ratio']);\r\n      }\r\n    }\r\n    return index;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Lấy giá trị của discount_bill theo khách hàng\r\n   * @param selectedBill bill đang chọn \r\n   * @param subTotal subTotal hiện tại\r\n   * @returns giá trị của discount_bill\r\n   */\r\n  getDiscountBillByCustomer(selectedBill, subTotal) {\r\n    return this.vhQuerySales.getDiscount_bill_byCustomer(subTotal, selectedBill.id_customer)\r\n      ? this.vhQuerySales.getDiscount_bill_byCustomer(subTotal, selectedBill.id_customer).discount\r\n      : 0;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Trả về dữ liệu thông tin bill_detail clean để lưu DB\r\n   * @param billDetails danh sách bill_detail\r\n   * @returns VhSaleInvoiceDetailEdit[]\r\n   * @example this.getCreateUpdateInvoiceDetail(billDetails);\r\n   */\r\n  getCreateUpdateInvoiceDetail(billDetails): VhSaleInvoiceDetailEdit[] {\r\n    return billDetails.map(item => {\r\n      if (!item.pmtype) {\r\n        let detail: VhSaleInvoiceDetailEdit = {\r\n          id_product: item.id_product,\r\n          ptype: item.ptype,\r\n          price: item.price,\r\n          price_origin: item.price_origin,\r\n          quantity: item.quantity,\r\n          earning_points_product: item.earning_points_product,\r\n          ratio: item.ratio,\r\n          note: item.note,\r\n          time_start_order: item.time_start_order,\r\n          time_end_order: item.time_end_order,\r\n          is_paused: item.is_paused,\r\n        };\r\n        if (item._id) detail['_id'] = item._id;\r\n        if (item.id_lotproduct) detail['id_lotproduct'] = item.id_lotproduct;\r\n        if (item.id_subproduct) detail['id_subproduct'] = item.id_subproduct;\r\n\r\n        if (item.ptype == 5) {\r\n          detail['combos'] = item.combos.map(combo => {\r\n            let product: VhSaleDesktopInvoiceDetailCombo = {\r\n                id_product: combo.id_product,\r\n                price: combo.price,\r\n                quantity: combo.quantity,\r\n                ptype: combo.ptype,\r\n                ratio: combo.ratio ? combo.ratio : 1,\r\n              };\r\n              if (combo.id_lotproduct) product['id_lotproduct'] = combo.id_lotproduct;\r\n              if (combo.id_subproduct) product['id_subproduct'] = combo.id_subproduct;\r\n              return product;\r\n            });\r\n          }\r\n          return detail;\r\n      }\r\n      else {\r\n        let detail: any = {\r\n          id_promotion: item.id_promotion,\r\n          pmtype: item.pmtype,\r\n        }\r\n        if (item._id) detail['_id'] = item._id;\r\n        if (item.products_gift) {\r\n          if (item.products_gift.filter(ele => ele.choose).length) {\r\n            detail['products_gift'] = item.products_gift.filter(ele => ele.choose).map(e => {\r\n              let prod = {\r\n                id_product: e.id_product,\r\n                price: e.price,\r\n                price_origin: e.price_origin,\r\n                quantity: e.quantity,\r\n                ptype: e.ptype,\r\n                earning_points_product: e.earning_points_product,\r\n                ratio: e.ratio\r\n              };\r\n              if (e.ptype == 5) {\r\n                prod['combos'] = e.combos.map(combo => {\r\n                  let product: VhSaleDesktopInvoiceDetailCombo = {\r\n                    id_product: combo.id_product,\r\n                    price: combo.price,\r\n                    quantity: combo.quantity,\r\n                    ptype: combo.ptype,\r\n                    ratio: combo.ratio ? combo.ratio : 1,\r\n                  };\r\n                  if (combo.id_lotproduct) product['id_lotproduct'] = combo.id_lotproduct;\r\n                  if (combo.id_subproduct) product['id_subproduct'] = combo.id_subproduct;\r\n                  return product;\r\n                });\r\n              }\r\n              if (e.id_lotproduct) prod['id_lotproduct'] = e.id_lotproduct;\r\n              if (e.id_subproduct) prod['id_subproduct'] = e.id_subproduct;\r\n              return prod;\r\n            });\r\n            return detail;\r\n          }\r\n        }\r\n        else {\r\n          detail['products'] = item.products.map(e => {\r\n            let prod = {\r\n              id_product: e.id_product,\r\n              price: e.price,\r\n              price_origin: e.price_origin,\r\n              quantity: e.quantity,\r\n              ptype: e.ptype,\r\n              earning_points_product: e.earning_points_product,\r\n              ratio: e.ratio,\r\n              note: item.note\r\n            };\r\n            if (e.ptype == 5) {\r\n              prod['combos'] = e.combos.map(combo => {\r\n                let product: VhSaleDesktopInvoiceDetailCombo = {\r\n                  id_product: combo.id_product,\r\n                  price: combo.price,\r\n                  quantity: combo.quantity,\r\n                  ptype: combo.ptype,\r\n                  ratio: combo.ratio ? combo.ratio : 1,\r\n                };\r\n                if (combo.id_lotproduct) product['id_lotproduct'] = combo.id_lotproduct;\r\n                if (combo.id_subproduct) product['id_subproduct'] = combo.id_subproduct;\r\n                return product;\r\n              });\r\n            }\r\n            if (e.id_lotproduct) prod['id_lotproduct'] = e.id_lotproduct;\r\n            if (e.id_subproduct) prod['id_subproduct'] = e.id_subproduct;\r\n            return prod;\r\n          });\r\n          return detail;\r\n        }\r\n      }\r\n    }).filter(item => item);\r\n  }\r\n\r\n\r\n\r\n  /* -------------------------------------------------------------------------------------------------------------------------------------- */\r\n  /*                                                             HÓA ĐƠN ĐIỆN TỬ                                                            */\r\n  /* -------------------------------------------------------------------------------------------------------------------------------------- */\r\n\r\n\r\n\r\n  /**\r\n   * Chuyển đổi bill từ local sang hóa đơn điện tử.\r\n   * Nếu có truyền vào platform và có bật cấu hình Gửi hóa đơn lên Cơ quan thuế kèm phí giao dịch/phí sàn thì sẽ tính thêm phí sàn vào bill_detail Chiết khấu thương mại\r\n   * @example\r\n   * this.vhQuerySales.changeBill_byLocal_toInvoice_byMinvoice(id_bill,invoiceSeries)       \r\n    .then((rsp)=>{    \r\n      //-----------your code here-----------                      \r\n    },(error:any)=>{\r\n        console.log('error', error)\r\n    })\r\n   * @param id_bill \r\n   * @param invoiceSeries   \r\n   * @param platform 'SHOPEE' | 'TIKTOK' | 'LAZADA'| 'TIKI' tên sàn\r\n   * @param infoShop Thông tin sàn\r\n   * \r\n   * @returns Promise => {vcode, msg, data(array)}\r\n   */\r\n  public changeBill_byLocal_toInvoice_byMinvoice(id_bill: string, invoiceSeries: string, platform?: 'SHOPEE' | 'TIKTOK' | 'LAZADA'| 'TIKI', infoShop?: any): Promise<any> {\r\n\r\n    /** Hàng khuyến mãi được phép xuất 0đ. Nếu là true thì tchat2 sẽ có các cột = 0, ma_thue vẫn là số bình thường */\r\n    const cqt_vat_ecommerce_allow_promotional_items_zero_price = this.vhQuerySales.getLocalAppSettingNameBranch('permission_branch').cqt_vat_ecommerce_allow_promotional_items_zero_price;\r\n    /** Xuất riêng chiết khấu/giảm giá của sản phẩm thành 1 dòng riêng khi gửi CQT */\r\n    const cqt_vat_ecommerce_separate_discount_line = this.vhQuerySales.getLocalAppSettingNameBranch('permission_branch').cqt_vat_ecommerce_separate_discount_line;\r\n    /** Vẫn giữ hàng xuất bán cho sản phẩm tặng/khuyến mãi khi gửi CQT */\r\n    const cqt_vat_ecommerce_keep_promotional_items_as_sold = this.vhQuerySales.getLocalAppSettingNameBranch('permission_branch').cqt_vat_ecommerce_keep_promotional_items_as_sold;\r\n    /** Gửi hóa đơn lên Cơ quan thuế kèm phí giao dịch/phí sàn */\r\n    const cqt_submit_invoice_with_ecommerce_fee = this.vhQuerySales.getLocalAppSettingNameBranch('permission_branch').cqt_submit_invoice_with_ecommerce_fee;\r\n    /** Mã sản phẩm khi gửi CQT là mã vạch sản phẩm */\r\n    const cqt_vat_ecommerce_item_code_is_barcode = this.vhQuerySales.getLocalAppSettingNameBranch('permission_branch').cqt_vat_ecommerce_item_code_is_barcode;\r\n    /** Giá hàng hóa, dịch vụ... gửi CQT là giá bán đã giảm */\r\n    const cqt_vat_ecommerce_item_price_is_discounted = this.vhQuerySales.getLocalAppSettingNameBranch('permission_branch').cqt_vat_ecommerce_item_price_is_discounted;\r\n\r\n    return new Promise<any>((resolve, reject) => {\r\n      (async () => {\r\n        try {\r\n          let invoices = new Array();\r\n          // Khởi tạo mảng Promise\r\n          const promises = [\r\n            this.vhQuerySales.getBill(id_bill),\r\n            this.vhQuerySales.getBill_details_byId_bill(id_bill)\r\n          ];\r\n          // Sử dụng await để lấy kết quả từ Promise.all()\r\n          const [bill, bill_details] = await Promise.all(promises).catch((err) => {\r\n            console.error('❌ Lỗi trong quá trình lấy dữ liệu:', err);\r\n            throw new Error('Không thể lấy dữ liệu hóa đơn');\r\n          }) as [any, any[]];\r\n\r\n          console.log('bill', bill);\r\n          console.log('bill_details', bill_details);\r\n\r\n          \r\n\r\n          /* ---------------------------------------------------------- Khởi tạo invoice ---------------------------------------------------------- */\r\n\r\n          let invoice: any = {\r\n            inv_invoiceSeries: invoiceSeries,\r\n            inv_invoiceIssuedDate: this.vhAlgorithm.formatDateToString(new Date()),\r\n            inv_currencyCode: \"VND\",\r\n            inv_exchangeRate: 1,\r\n\r\n            inv_paymentMethodName: bill.payment_type == 1 ? \"Tiền mặt\" : \"Chuyển khoản\",\r\n\r\n            inv_buyerDisplayName: bill.tax_buyerDisplayName,\r\n            inv_buyerLegalName: bill.tax_buyerLegalName,\r\n            inv_buyerTaxCode: bill.tax_buyerTaxCode,\r\n            inv_buyerAddressLine: bill.tax_buyerAddressLine,\r\n\r\n            inv_discountAmount: 0, // Tổng tiền chiết khấu (tổng của cột Tiền chiết khấu)\r\n            inv_TotalAmountWithoutVat: 0, // Cộng tiền hàng (Đã trừ CK) Chưa bao gồm VAT (cột Thành tiền trước thuế, = +tchat1 -tchat3 bỏ qua tchat2)\r\n            inv_vatAmount: 0, // Tiền thuế GTGT (= Cộng tiền hàng (Đã trừ CK) Chưa bao gồm VAT * bill.tax / 100)\r\n            inv_TotalAmount: 0, // Tổng cộng tiền thanh toán (sau thuế) (= Cộng tiền hàng (Đã trừ CK) Chưa bao gồm VAT + Tiền thuế GTGT) tương đương trườnG payment của mình\r\n\r\n            key_api: id_bill,\r\n            so_benh_an: bill.bill_code\r\n          }\r\n\r\n\r\n\r\n          /* ------------------------------------------------------ Tính toán invoice details ----------------------------------------------------- */\r\n          \r\n          /** Danh sách bill details */\r\n          var invoice_details = new Array();\r\n\r\n          /* ------------------------------------------------------ Lặp qua các bill details ------------------------------------------------------ */\r\n          for (let i = 0; i < bill_details.length; i++) {\r\n            // Bắt tường hợp CÓ Chương trình khuyến mãi\r\n            /** Danh sách sản phẩm của đơn */\r\n            let products = bill_details[i].products_gift || bill_details[i].products || [bill_details[i]];\r\n\r\n            /* --------------------------------- Xử lý phân tách sản phẩm trong combo thành danh sách từng sản phẩm --------------------------------- */\r\n            /** Mảng chứa danh sách sản phẩm trong combo */\r\n            let productsCombo = [];\r\n            for (let j = 0; j < products.length; j++) {\r\n              // check xem có sản phẩm ptype: 5 (combo)\r\n              if (products[j].ptype === VhType.COMBO && products[j].combos && products[j].combos.length > 0) {\r\n                /** % Giảm giá. Bắt thêm trường hợp price_origin = 0 */\r\n                const percentDiscount = products[j].price_origin > 0 \r\n                  ? (products[j].price_origin - products[j].price) / products[j].price_origin \r\n                  : 0;\r\n                // Nếu có thì lấy tất cả sản phẩm trong combo\r\n                const productInCombo = products[j].combos.map(combo => {\r\n                  return {\r\n                    ...combo,\r\n                    price_origin: this.vhQuerySales.getUnit_byRatio(combo.units, combo.ratio)?.price,\r\n                    price: combo.price * (1 - percentDiscount),\r\n                  };\r\n                })\r\n                // Thêm danh sách sản phẩm vào mảng\r\n                productsCombo = productsCombo.concat(productInCombo);\r\n                // Xóa sản phẩm combo khỏi danh sách products\r\n                products.splice(j, 1);\r\n                j--; // Giảm j để không bỏ qua sản phẩm tiếp theo\r\n              }\r\n            }\r\n\r\n            // Nếu có sản phẩm combo thì thêm vào danh sách products\r\n            if (productsCombo.length > 0) {\r\n              products = products.concat(productsCombo);\r\n            }\r\n\r\n            // Lăp qua danh sách sản phẩm\r\n            for (let j = 0; j < products.length; j++) {\r\n              let id_sub_or_product = products[j].id_subproduct ? products[j].id_subproduct : products[j].id_product;\r\n              let product: any = await this.vhQuerySales.getlocalDetailProduct(id_sub_or_product);\r\n\r\n              // Trường hợp giá bán > giá gốc\r\n              if(products[j].price > products[j].price_origin) {\r\n                products[j].price_origin = products[j].price;\r\n              }\r\n\r\n              /** Đơn vị của sản phẩm, bắt trường hợp Dịch vụ thời gian thì thêm Dịch */\r\n              let unitCodeValue = this.vhQuerySales.getUnit_byRatio(product.units, products[j].ratio)?.unit;\r\n              const serviceTimeUnitMap = {\r\n                'day': 'Ngày',\r\n                'hour': 'Giờ',\r\n                'minute': 'Phút',\r\n                'second': 'Giây'\r\n              }\r\n              if(product.type === VhType.SERVICETIME) unitCodeValue = serviceTimeUnitMap[unitCodeValue] || unitCodeValue;\r\n\r\n              /** Tính chất hàng hóa, nếu giá bán = 0 thì là hàng khuyến mại, ngược lại là hàng hóa dịch vụ */\r\n              const tchat = products[j].price == 0 ? 2 : 1;\r\n\r\n              // Khởi tạo chi tiết hóa đơn\r\n              let invoice_detail = this.createEInvoiceDetailTemplate();\r\n\r\n              // Gán các giá trị chung\r\n              invoice_detail.tchat = tchat;\r\n              invoice_detail.stt_rec0 = invoice_details.length + 1;\r\n              invoice_detail.inv_unitCode = unitCodeValue;\r\n              invoice_detail.inv_quantity = products[j].quantity;\r\n              invoice_detail.inv_unitPrice = products[j].price_origin; // (Đơn giá)\r\n              invoice_detail.ma_thue = bill.tax; // % thuế\r\n\r\n\r\n              /* ------ Xử lý cqt_vat_ecommerce_item_code_is_barcode ------------------------------------------ */\r\n              if(cqt_vat_ecommerce_item_code_is_barcode) {\r\n                const barcode = this.vhQuerySales.getUnit_byRatio(product.units, products[j].ratio)?.barcode;\r\n                // Nếu có barcode thì dùng barcode\r\n                if(barcode) {\r\n                  invoice_detail.inv_itemCode = barcode;\r\n                }\r\n                // Nếu không có barcode thì thông báo\r\n                else {\r\n                  this.vhComponent.alertMessageDesktop(\"error\", this.languageService.translate(\"Gửi hóa đơn lên CQT thất bại. Hóa đơn có chứa sản phẩm chưa có mã vạch, vui lòng bổ sung và thử lại. Hoặc bỏ chọn cấu hình Mã sản phẩm khi xuất hóa đơn là mã vạch để tiếp tục\"), 5000);\r\n                  reject(new Error('Gửi hóa đơn lên CQT thất bại. Hóa đơn có chứa sản phẩm chưa có mã vạch, vui lòng bổ sung và thử lại. Hoặc bỏ chọn cấu hình Mã sản phẩm khi xuất hóa đơn là mã vạch để tiếp tục'));\r\n                }\r\n              }\r\n              else {\r\n                invoice_detail.inv_itemCode = products[j]._id || products[j].id_product;\r\n              }\r\n\r\n\r\n              /* ------ Xử lý tchat --------------------------------------------------------------------------- */\r\n              if (tchat === 2) {\r\n                // Gán lại tên\r\n                invoice_detail.inv_itemName = 'Hàng khuyến mãi/hàng tặng ' + product.name;\r\n                // Tính lại giá trị trợ giá (chiết khấu) của chi tiết hóa đơn trường hợp tchat2\r\n                invoice_detail.inv_discountAmount = 0;\r\n                // Trợ giá (chiết khấu) tính theo %\r\n                invoice_detail.inv_discountPercentage = 0;\r\n\r\n                /* ------ Xử lý Hàng khuyến mãi được phép xuất 0đ ----------------------------------------------- */\r\n                // Nếu có bật cqt_vat_ecommerce_allow_promotional_items_zero_price và là tchat2 thì cần gán lại giá = 0, để các phép tính cho những trường khác bên dưới cũng sẽ tự tính = 0\r\n                if(cqt_vat_ecommerce_allow_promotional_items_zero_price) {\r\n                  invoice_detail.inv_unitPrice = 0;\r\n                }\r\n\r\n                /* ------ Xử lý Vẫn giữ hàng xuất bán cho sản phẩm tặng/khuyến mãi khi gửi CQT ------------------ */\r\n                // Nếu có bật cqt_vat_ecommerce_keep_promotional_items_as_sold và là tchat2 thì sẽ set lại nso thành tchat1, discountAmount và discountPercentage vẫn là 0\r\n                if(cqt_vat_ecommerce_keep_promotional_items_as_sold) {\r\n                  // Gán lại tchat\r\n                  invoice_detail.tchat = 1; // Gán lại tchat thành 1\r\n                  // Gán lại tên\r\n                  invoice_detail.inv_itemName = product.name;\r\n                }\r\n              }\r\n              else {\r\n                // Gán lại tên\r\n                invoice_detail.inv_itemName = product.name;\r\n                // Trợ giá (chiết khấu) của nhà bán hàng trên mỗi chi tiết hóa đơn = seller_discount + shopee_discount\r\n                invoice_detail.inv_discountAmount = this.roundTo4Decimal((invoice_detail.inv_unitPrice - products[j].price) * invoice_detail.inv_quantity);\r\n\r\n                /* ------ Xử lý Giá hàng hóa, dịch vụ... gửi CQT là giá bán đã giảm ----------------------------------------- */\r\n                if(cqt_vat_ecommerce_item_price_is_discounted) {\r\n                  // Gán lại thành giá đã giảm\r\n                  invoice_detail.inv_unitPrice = invoice_detail.inv_unitPrice - invoice_detail.inv_discountAmount / invoice_detail.inv_quantity;\r\n                  // Gán lại Chiết khấu = 0\r\n                  invoice_detail.inv_discountAmount = 0;\r\n                }\r\n\r\n                // Trợ giá (chiết khấu) tính theo %\r\n                invoice_detail.inv_discountPercentage = (invoice_detail.inv_unitPrice - products[j].price) / invoice_detail.inv_unitPrice * 100;\r\n              }\r\n\r\n              // Giá cuối (đã trừ trợ giá) của chi tiết hóa đơn\r\n              invoice_detail.inv_TotalAmountWithoutVat = this.roundTo4Decimal(invoice_detail.inv_unitPrice * invoice_detail.inv_quantity - invoice_detail.inv_discountAmount);\r\n              //Thuế VAT được tính theo chi tiết hóa đơn\r\n              invoice_detail.inv_vatAmount = this.roundTo4Decimal(invoice_detail.inv_TotalAmountWithoutVat * invoice_detail.ma_thue / 100);\r\n              //Tổng giá trị hàng hóa kê khai theo chi tiết hóa đơn\r\n              invoice_detail.inv_TotalAmount = invoice_detail.inv_TotalAmountWithoutVat + invoice_detail.inv_vatAmount;\r\n\r\n              // Thêm vào mảng\r\n              invoice_details = this.addEInvoiceDetail(invoice_detail, invoice_details, {cqt_vat_ecommerce_separate_discount_line: cqt_vat_ecommerce_separate_discount_line});\r\n            }\r\n          }\r\n\r\n\r\n\r\n          /* -------------------------------------------------------------- Xử lý Phí ------------------------------------------------------------- */\r\n\r\n          // Xử lý cho phí\r\n          // Nếu fee > 0 thì thêm 1 invoice detail cho phí\r\n          if(bill.fee > 0) {\r\n            // Khởi tạo chi tiết hóa đơn\r\n            let invoice_detail = this.createEInvoiceDetailTemplate();\r\n            \r\n            // Gán các giá trị chung\r\n            invoice_detail.tchat = 1;\r\n            invoice_detail.stt_rec0 = invoice_details.length + 1;\r\n            invoice_detail.inv_itemCode = 'phi_phu_thu';\r\n            invoice_detail.inv_itemName = 'Phụ thu';\r\n            invoice_detail.inv_unitCode = 'Lần';\r\n            invoice_detail.inv_quantity = 1;\r\n            invoice_detail.inv_unitPrice = bill.fee;\r\n            invoice_detail.inv_TotalAmountWithoutVat = this.roundTo4Decimal(bill.fee); // Thành tiền trước thuế\r\n            invoice_detail.ma_thue = bill.tax; // % thuế\r\n\r\n            // Thuế VAT được tính theo chi tiết hóa đơn\r\n            invoice_detail.inv_vatAmount = invoice_detail.inv_unitPrice * (invoice_detail.ma_thue / 100);\r\n            // Tổng giá trị hàng hóa kê khai theo chi tiết hóa đơn\r\n            invoice_detail.inv_TotalAmount = invoice_detail.inv_TotalAmountWithoutVat + invoice_detail.inv_vatAmount;\r\n\r\n            // Thêm vào mảng\r\n            invoice_details = this.addEInvoiceDetail(invoice_detail, invoice_details, {cqt_vat_ecommerce_separate_discount_line: cqt_vat_ecommerce_separate_discount_line});\r\n          }\r\n\r\n\r\n\r\n          /* ----------------------------------------------------------- Xử lý giảm giá ----------------------------------------------------------- */\r\n\r\n          // Tính phí sàn\r\n          let platformFee = 0;\r\n          if (cqt_submit_invoice_with_ecommerce_fee && platform && infoShop) {\r\n            platformFee = await this.calculatePlatformFee(bill, platform, infoShop);\r\n            console.log('platformFee:', platformFee);\r\n          }\r\n\r\n          // Xử lý phần giảm giá (Giảm giá + Chiết khấu + Thanh toán điểm + Thanh toán phiếu)\r\n          // tạo thành 1 invoice detail cso tchat3 cho phần giảm giá\r\n          // invoice này vẫn sẽ tính thuế, nhưng khi tính tổng thuế sẽ bỏ qua nó (tương đương bill.total * (bill.tax / 100) của mình)\r\n          if((bill.payment_points ?? 0) > 0 || (bill.payment_coupons ?? 0) > 0 || (bill.discount_bill ?? 0) > 0 || (bill.discount ?? 0) > 0 || (cqt_submit_invoice_with_ecommerce_fee && platformFee > 0)) {\r\n            /** Tổng tiền giảm giá (Tổng tiền chiết khấu) */\r\n            let totalDiscountAmount = (bill.payment_points ?? 0) + (bill.payment_coupons ?? 0) + (bill.discount_bill ?? 0) + (bill.discount ?? 0);\r\n            // Nếu có phí sàn thì cộng thêm vào\r\n            if(cqt_submit_invoice_with_ecommerce_fee && platformFee > 0) {\r\n              totalDiscountAmount += platformFee;\r\n            }\r\n            /** Tiền thuế */\r\n            const vatAmount = totalDiscountAmount * (bill.tax / 100);\r\n\r\n            // Khởi tạo chi tiết hóa đơn\r\n            let invoice_detail = this.createEInvoiceDetailTemplate();\r\n            \r\n            // Gán các giá trị chung\r\n            invoice_detail.tchat = 3;\r\n            invoice_detail.stt_rec0 = invoice_details.length + 1;\r\n            invoice_detail.inv_itemCode = 'chiet_khau_thuong_mai';\r\n            invoice_detail.inv_itemName = 'Chiết khấu thương mại';\r\n            invoice_detail.inv_unitCode = 'Phần';\r\n            invoice_detail.inv_quantity = 1;\r\n            invoice_detail.inv_unitPrice = totalDiscountAmount;\r\n            invoice_detail.inv_TotalAmountWithoutVat = this.roundTo4Decimal(totalDiscountAmount); // Thành tiền trước thuế\r\n            invoice_detail.ma_thue = bill.tax; // % thuế\r\n            invoice_detail.inv_vatAmount = this.roundTo4Decimal(vatAmount); // tiền thuế (Tiền thuế GTGT)\r\n            invoice_detail.inv_TotalAmount = this.roundTo4Decimal(totalDiscountAmount + vatAmount); // tổng tiền sau thuế (Thành tiền sau thuế)\r\n\r\n            // Thêm vào mảng\r\n            invoice_details = this.addEInvoiceDetail(invoice_detail, invoice_details, {cqt_vat_ecommerce_separate_discount_line: cqt_vat_ecommerce_separate_discount_line});\r\n          }\r\n\r\n\r\n\r\n          /* ---------------------------------------------- Gán lại các trường tính toán cho invoice ---------------------------------------------- */\r\n\r\n          for (let i = 0; i < invoice_details.length; i++) {\r\n            if (invoice_details[i].tchat == 1) {\r\n              // tchat 1 thì cộng dồn\r\n              invoice.inv_discountAmount += invoice_details[i].inv_discountAmount;\r\n              invoice.inv_vatAmount += invoice_details[i].inv_vatAmount;\r\n              invoice.inv_TotalAmountWithoutVat += invoice_details[i].inv_TotalAmountWithoutVat;\r\n              invoice.inv_TotalAmount += invoice_details[i].inv_TotalAmount;\r\n            } else if (invoice_details[i].tchat == 2) {\r\n              // tchat 2 thì bỏ qua\r\n            } else if (invoice_details[i].tchat == 3) {\r\n              // tchat 3 thì phải trừ lại\r\n              invoice.inv_discountAmount -= invoice_details[i].inv_discountAmount;\r\n              invoice.inv_vatAmount -= invoice_details[i].inv_vatAmount;\r\n              invoice.inv_TotalAmountWithoutVat -= invoice_details[i].inv_TotalAmountWithoutVat;\r\n              invoice.inv_TotalAmount -= invoice_details[i].inv_TotalAmount;\r\n            }\r\n          }\r\n\r\n\r\n          /* ----------------------------------------------------------- Trả về giá trị ----------------------------------------------------------- */\r\n\r\n          invoices = [{ ...invoice, details: [{ data: invoice_details }] }];\r\n          console.log('data', invoices);\r\n          resolve({ vcode: 0, msg: 'success', data: invoices });\r\n        } catch (err) {\r\n          console.error('❌ Lỗi saveInvoice_noSign_byMinvoice:', err);\r\n          reject(err);\r\n        }\r\n      })()\r\n    })\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Công thức tính giá mới của sản phẩm (newPrice) để total sau khi áp thuế (thuế từ phần cài đặt của app mình) không thay đổi\r\n   *\r\n   * ((gia * sl - ck) / (1 + thue_cai_dat) + ck) / sl\r\n   * \r\n   * @param unitPrice Giá cũ\r\n   * @param quantity Số lượng sản phẩm\r\n   * @param discountAmount Tiền chiết khấu\r\n   * @param taxSetting Thuế từ phần cài đặt của app mình (ví dụ 20% thì truyền vào: 20)\r\n   * @param taxPlatform Thuế từ sàn (ví dụ 10% thì truyền vào: 10)\r\n   * \r\n   * @returns Giá mới của sản phẩm (newPrice) để total sau khi áp thuế không thay đổi\r\n   *\r\n   * @example\r\n   *\r\n    Tính giá mới của sản phẩm (newPrice) để total sau khi áp thuế (thuế từ phần cài đặt của app mình) không thay đổi\r\n\r\n    vd: sl = 2, gia = 15000, ck = 5000, thue_san = 50%\r\n    => total = ((gia * sl) - ck) * (1 + thue_san)\r\n    => total = ((15000 * 2) - 5000) * (1 + 0.5)\r\n    => total = 37500\r\n\r\n    thue_cai_dat = 20% (thuế từ phần cài đặt của app mình)\r\n    total = ((newPrice * sl - ck)) * (1 + thue_cai_dat)\r\n    => newPrice = (total / (1 + thue_cai_dat) + ck) / sl   hoặc   ((((gia * sl) - ck) * (1 + thue_san)) / (1 + thue_cai_dat) + ck) / sl\r\n    => newPrice = (37500 / (1 + 0.2) + 5000) / 2\r\n    => newPrice = 18125\r\n\r\n    thay 18125 vào công thức tính total với thuế cài đặt (sẽ bỏ qua thuế sàn)\r\n    => total = ((gia * sl) - ck) * (1 + thue_cai_dat)\r\n    => total = ((18125 * 2) - 5000) * (1 + 0.2)\r\n    => total = 37500\r\n    => total vẫn là 37500 không thay đổi\r\n\r\n\r\n    Công thức tính ngược lại giá cảu sản phẩm:\r\n    unitPrice = ((((newPrice * quantity - discountAmount) * (1 + taxSetting / 100)) / (1 + taxPlatform / 100)) + discountAmount) / quantity\r\n\r\n    \r\n    Sử dụng:\r\n\r\n    invoice_detail.inv_unitPrice = calculateNewPrice(invoice_detail.inv_unitPrice, invoice_detail.inv_quantity, invoice_detail.inv_discountAmount, invoice_detail.ma_thue, platformTax);\r\n   \r\n   */\r\n  calculateNewPriceToUseSettingTax(unitPrice, quantity, discountAmount, taxSetting, taxPlatform): number {\r\n    return (((unitPrice * quantity - discountAmount) * (1 + taxPlatform / 100)) / (1 + taxSetting / 100) + discountAmount) / quantity;\r\n  }\r\n\r\n\r\n\r\n  /** \r\n   * Làm tròn 4 chữ số thập phân. VD: 123.456789 => 123.4568; 123.45671 => 123.4567\r\n   * \r\n   * @param num Số cần làm tròn\r\n   * \r\n   * @return Số đã làm tròn đến 4 chữ số thập phân\r\n   * \r\n   * @example\r\n   * this.roundTo4Decimal(123.456789); // 123.4568\r\n   */\r\n  roundTo4Decimal(num: any): number {\r\n    return parseFloat(num.toFixed(4));\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Khởi tạo một object chi tiết hoá đơn điện tử với các trường mặc định.\r\n   * tchat = 1, các trường số thì mặc định là 0, các trường chuỗi thì mặc định là rỗng.\r\n   * @returns object mặc định\r\n   * @example\r\n   * let invoice_detail = this.billService.createEInvoiceDetailTemplate();\r\n   * \r\n   * Mẫu khởi tạo với các trường mặc định:\r\n    {\r\n      tchat: 1, // Tính chất hàng hóa: Hàng hóa dịch vụ (giá trị tchat là 1); Khuyến mại (giá trị tchat là 2); Chiết khấu thương mại (giá trị tchat là 3); Ghi chú/ diễn giải (giá trị tchat là 4); Hàng hóa đăc trưng (giá trị tchat là 5)\r\n      stt_rec0: 0, // Số thứ tự của sản phẩm trong hóa đơn\r\n      inv_itemCode: '', // Mã sản phẩm\r\n      inv_itemName: '', // Tên sản phẩm, nếu tchatValue là 2 thì thêm chữ \"Hàng khuyến mãi/hàng tặng\" vào trước tên sản phẩm\r\n      inv_unitCode: '', // Đơn vị của sản phẩm\r\n      inv_quantity: 0, // Số lượng sản phẩm\r\n      inv_unitPrice: 0, // Giá gốc bán sản phẩm\r\n      ma_thue: 0, // % thuế\r\n      inv_discountPercentage: 0,\r\n      inv_discountAmount: 0, // Tiền chiết khấu (Giảm giá)\r\n      inv_TotalAmountWithoutVat: 0, // Thành tiền trước thuế\r\n      inv_vatAmount: 0, // thuế (Tiền thuế GTGT)\r\n      inv_TotalAmount: 0 // Thành tiền sau thuế\r\n    };\r\n   */\r\n  createEInvoiceDetailTemplate() {\r\n    return {\r\n      tchat: 1, // Tính chất hàng hóa: Hàng hóa dịch vụ (giá trị tchat là 1); Khuyến mại (giá trị tchat là 2); Chiết khấu thương mại (giá trị tchat là 3); Ghi chú/ diễn giải (giá trị tchat là 4); Hàng hóa đăc trưng (giá trị tchat là 5)\r\n      stt_rec0: 0, // Số thứ tự của sản phẩm trong hóa đơn\r\n      inv_itemCode: '', // Mã sản phẩm\r\n      inv_itemName: '', // Tên sản phẩm, nếu tchatValue là 2 thì thêm chữ \"Hàng khuyến mãi/hàng tặng\" vào trước tên sản phẩm\r\n      inv_unitCode: '', // Đơn vị của sản phẩm\r\n      inv_quantity: 0, // Số lượng sản phẩm\r\n      inv_unitPrice: 0, // Giá gốc bán sản phẩm\r\n      ma_thue: 0, // % thuế\r\n      inv_discountPercentage: 0, // % tiền chiết khấu (Giảm giá). Không thể để 100 vì khi 100% thì là tchat2 rồi\r\n      inv_discountAmount: 0, // Tiền chiết khấu (Giảm giá)\r\n      inv_TotalAmountWithoutVat: 0, // Thành tiền trước thuế\r\n      inv_vatAmount: 0, // thuế (Tiền thuế GTGT)\r\n      inv_TotalAmount: 0 // Thành tiền sau thuế\r\n    };\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Thêm invoice_detail vào invoice_details. Và kiểm tra các setting trong settings\r\n   * \r\n   * `cqt_vat_ecommerce_separate_discount_line` là true và `tchat1` và `inv_discountAmount > 0` thì sẽ tách chiết khấu ra thành một dòng riêng trong invoice_details.\r\n   * \r\n   * @param invoice_detail invoice_detail cần thêm vào invoice_details\r\n   * @param invoice_details Danh sách invoice_details hiện tại \r\n   * @param settings Các cài đặt sẽ kiểm tra \r\n   * @returns Mảng invoice_details sau khi thêm\r\n   */\r\n  addEInvoiceDetail(invoice_detail: any, invoice_details: any[], settings: { cqt_vat_ecommerce_separate_discount_line: boolean }): any[] {\r\n    // Nếu KHÔNG cqt_vat_ecommerce_separate_discount_line hoặc KHÔNG phải tchat1 hoặc inv_discountAmount <= 0 thì thêm thẳng vào invoice_details\r\n    if (!settings.cqt_vat_ecommerce_separate_discount_line || invoice_detail.tchat !== 1 || invoice_detail.inv_discountAmount <= 0) {\r\n      invoice_details.push(invoice_detail);\r\n      return invoice_details;\r\n    }\r\n\r\n\r\n    // NGƯỢC LẠI\r\n    // Sẽ tách ra thành 2 invoice_detail:\r\n    // 1. invoice_detail hiện tại (tchat1) sẽ giữ nguyên các trường như cũ, gán lại inv_discountAmount = 0, inv_discountPercentage = 0, tính lại inv_TotalAmountWithoutVat, inv_vatAmount, inv_TotalAmount\r\n    // 2. invoice_detail mới (tchat3) sẽ set các trường như sau:\r\n    //    - tchat = 3\r\n    //    - stt_rec0 = invoice_details.length + 1\r\n    //    - inv_itemCode = 'giam_gia_cho_' + cloneInvoiceDetail.inv_itemCode\r\n    //    - inv_itemName = 'Giảm giá ' + cloneInvoiceDetail.inv_discountAmount + ' cho ' + cloneInvoiceDetail.inv_itemName\r\n    //    - inv_unitCode = 'Phần'\r\n    //    - inv_quantity = 1\r\n    //    - inv_unitPrice = cloneInvoiceDetail.inv_discountAmount\r\n    //    - ma_thue = cloneInvoiceDetail.ma_thue\r\n    //    - inv_discountPercentage = 0\r\n    //    - inv_discountAmount = 0\r\n    //    - inv_TotalAmountWithoutVat, inv_vatAmount, inv_TotalAmount sẽ được tính lại dựa trên các trường mới này\r\n\r\n\r\n    /* ----- Tạo newInvoiceDetailId mới và gán lại các trường ------------------------------------------ */\r\n    const newInvoiceDetail = this.createEInvoiceDetailTemplate();\r\n    newInvoiceDetail.tchat = 3;\r\n    newInvoiceDetail.stt_rec0 = invoice_details.length + 2; // Cộng 2 là do lát nauwx sẽ chèn invoice_detail này vào sau invoice_detail hiện tại\r\n    newInvoiceDetail.inv_itemCode = 'giam_gia_cho_' + invoice_detail.inv_itemCode;\r\n    newInvoiceDetail.inv_itemName = 'Giảm giá ' + invoice_detail.inv_discountAmount + ' cho ' + invoice_detail.inv_itemName;\r\n    newInvoiceDetail.inv_unitCode = 'Phần';\r\n    newInvoiceDetail.inv_quantity = 1;\r\n    newInvoiceDetail.inv_unitPrice = invoice_detail.inv_discountAmount;\r\n    newInvoiceDetail.ma_thue = invoice_detail.ma_thue;\r\n    newInvoiceDetail.inv_discountPercentage = 0;\r\n    newInvoiceDetail.inv_discountAmount = 0;\r\n    newInvoiceDetail.inv_TotalAmountWithoutVat = newInvoiceDetail.inv_unitPrice * newInvoiceDetail.inv_quantity - newInvoiceDetail.inv_discountAmount;\r\n    newInvoiceDetail.inv_vatAmount = newInvoiceDetail.inv_TotalAmountWithoutVat * newInvoiceDetail.ma_thue / 100;\r\n    newInvoiceDetail.inv_TotalAmount = newInvoiceDetail.inv_TotalAmountWithoutVat + newInvoiceDetail.inv_vatAmount\r\n\r\n\r\n    /* ----- Xử lý invoice_detail hiện tại --------------------------------------------------- */\r\n    invoice_detail.inv_discountAmount = 0;\r\n    invoice_detail.inv_discountPercentage = 0;\r\n    invoice_detail.inv_TotalAmountWithoutVat = invoice_detail.inv_unitPrice * invoice_detail.inv_quantity - invoice_detail.inv_discountAmount; // Tính lại sau khi gán lại inv_discountAmount\r\n    invoice_detail.inv_vatAmount = invoice_detail.inv_TotalAmountWithoutVat * invoice_detail.ma_thue / 100; // Tính lại sau khi gán lại inv_discountAmount\r\n    invoice_detail.inv_TotalAmount = invoice_detail.inv_TotalAmountWithoutVat + invoice_detail.inv_vatAmount; // Tính lại sau khi gán lại inv_discountAmount\r\n    \r\n\r\n    /* ----- Thêm vào mảng ----------------------------------------------------------- */\r\n    // Thêm invoice_detail đã xử lý vào invoice_details\r\n    invoice_details.push(invoice_detail);\r\n    // Thêm newInvoiceDetail vào invoice_details\r\n    invoice_details.push(newInvoiceDetail);\r\n\r\n    // Trả về mảng invoice_details đã thêm mới\r\n    return invoice_details;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Get lại thông tin và tính phí sàn\r\n   * @param bill hóa đơn cần tính\r\n   * @param platform sàn cần tính\r\n   * @param infoShop \r\n   * @returns trả về số tiền Phí sàn\r\n   */\r\n  async calculatePlatformFee(bill: any, platform: 'SHOPEE' | 'TIKTOK' | 'LAZADA'| 'TIKI', infoShop: any): Promise<number> {\r\n    if (!platform || !infoShop) return 0;\r\n\r\n    let fee = 0;\r\n    switch (platform) {\r\n\r\n      /* --------------------------------------------------------------- SHOPEEE -------------------------------------------------------------- */\r\n      case 'SHOPEE':\r\n        const escrowShopee: any = await this.vhEcommerce.getEscrowShopee(bill.order_number_ecommerce, infoShop.access_token, infoShop._id)\r\n        fee = escrowShopee.order_income.seller_transaction_fee + escrowShopee.order_income.shipping_seller_protection_fee_amount + escrowShopee.order_income.commission_fee;\r\n        break;\r\n\r\n      /* --------------------------------------------------------------- TIKTOK --------------------------------------------------------------- */\r\n      case 'TIKTOK':\r\n        const transactionsTiktok: any = await this.vhEcommerce.getOrderStatementTransactionsTiktok(\r\n          infoShop.shop_cipher,\r\n          infoShop.app_key,\r\n          infoShop.access_token.toString(),\r\n          bill.order_number_ecommerce\r\n        );\r\n        fee = transactionsTiktok?.fee_and_tax_amount;\r\n        break;\r\n\r\n      /* --------------------------------------------------------------- LAZADA --------------------------------------------------------------- */\r\n      case 'LAZADA':\r\n        const date = new Date(bill.date);\r\n        date.setDate(date.getDate() - 30);\r\n        const startTime = date;\r\n        const endTime = new Date();\r\n        const json = {\r\n          start_time: startTime,\r\n          end_time: endTime,\r\n          limit: 100,\r\n          offset: 0,\r\n          trade_order_id: bill.order_number_ecommerce,\r\n          trans_type: -1,\r\n        };\r\n        const listFee = await this.vhQuerySales.getTransactionDetailsLazada(json, infoShop['access_token']) as any[];\r\n        const phi_co_dinh = this.calculateTotalLazadaFee(listFee, 'Commission');\r\n        const phi_xu_ly_don_hang = this.calculateTotalLazadaFee(listFee, 'Payment Fee');\r\n        fee = phi_co_dinh + phi_xu_ly_don_hang;\r\n        break;\r\n\r\n      /* ---------------------------------------------------------------- TIKI ---------------------------------------------------------------- */\r\n      case 'TIKI':\r\n        const tiki: any = await this.vhQuerySales.getSalesOrderDetailTiki(bill.order_number_ecommerce, infoShop['access_token'], infoShop['_id']);\r\n        let shipping_fee_discountAmount = 0;\r\n        for (let i = 0; i < tiki['items'].length; i++) {\r\n          // Cộng dồn tiền seller giảm giá phí ship\r\n          shipping_fee_discountAmount += tiki['items'][i].seller_income_detail.discount?.discount_shipping_fee?.seller_subsidy || 0;\r\n        }\r\n        fee = Math.abs(tiki?.invoice?.total_seller_fee) - shipping_fee_discountAmount;\r\n        break;\r\n\r\n      default:\r\n        fee = 0;\r\n    }\r\n    return fee;\r\n  }\r\n\r\n\r\n\r\n  calculateTotalLazadaFee(data: any[], typeFee: string): number {\r\n    return data\r\n      .filter(item => item.fee_name === typeFee)\r\n      .map(item => {\r\n        // Remove commas and convert to a number\r\n        const rawAmount = item.amount.replace(/,/g, '');\r\n        return Math.abs(parseFloat(rawAmount));\r\n      })\r\n      .reduce((total, amount) => total + amount, 0);\r\n  }\r\n\r\n}\r\n"],"names":["VhType","BillService","constructor","languageService","vhQuerySales","vhAuth","vhAlgorithm","vhComponent","vhEcommerce","getlocalTaxs","filter","item","status","getSubTotal","billDetails","subTotal","i","total_product_gift","total_products","products_gift","choose","reduce","prev","next","quantity","price","products","getTotalEarningPointProduct","product","promotion","program_product","include_promotion_product","find","_id","exchange","money","points","getTotal","bill","total","discount","discount_bill","payment_coupons","payment_points","fee","getTax","tax","getPaymentName","payment_type","id_wallet","translate","getlocalWallet","_a","name","getBillsToday","getBills_byFields","bill_type","$eq","id_branch","getDefaultBranch","id_employee","getUser","id_shop","getCleanBillDetail","detail","id_product","ptype","price_origin","earning_points_product","ratio","id_lotproduct","id_subproduct","combos","map","combo","updateBillDetail","id_bill_detail","callbackSuccess","callbackError","updateBill_Detail","then","bool","error","console","log","getEarningPointBill","program_bill","selectedBill","sub","bill_total_minimum","getSubTotalNotPromotion","include_discount","include_paid_points","include_fee","include_tax","id_promotion","getEarningPointAllProduct","getSubTotalNotPromotionOfProduct","getTotalEarningPoint","products_of_program_earnig_product","getPayment","taxValue","getCash","value","parseFloat","deleteBill","index","id","selectedIndex","Promise","resolve","reject","checkMyPermission","alertConfirm","closeSyncOpeningBill","showLoading","deleteBill_Billdetail","catch","cancel","Error","getBillDetailIndex","lot_number","findIndex","getDiscountBillByCustomer","getDiscount_bill_byCustomer","id_customer","getCreateUpdateInvoiceDetail","pmtype","note","time_start_order","time_end_order","is_paused","ele","length","e","prod","changeBill_byLocal_toInvoice_byMinvoice","id_bill","invoiceSeries","platform","infoShop","cqt_vat_ecommerce_allow_promotional_items_zero_price","getLocalAppSettingNameBranch","cqt_vat_ecommerce_separate_discount_line","cqt_vat_ecommerce_keep_promotional_items_as_sold","cqt_submit_invoice_with_ecommerce_fee","cqt_vat_ecommerce_item_code_is_barcode","cqt_vat_ecommerce_item_price_is_discounted","invoices","Array","promises","getBill","getBill_details_byId_bill","bill_details","all","err","invoice","inv_invoiceSeries","inv_invoiceIssuedDate","formatDateToString","Date","inv_currencyCode","inv_exchangeRate","inv_paymentMethodName","inv_buyerDisplayName","tax_buyerDisplayName","inv_buyerLegalName","tax_buyerLegalName","inv_buyerTaxCode","tax_buyerTaxCode","inv_buyerAddressLine","tax_buyerAddressLine","inv_discountAmount","inv_TotalAmountWithoutVat","inv_vatAmount","inv_TotalAmount","key_api","so_benh_an","bill_code","invoice_details","productsCombo","j","COMBO","percentDiscount","productInCombo","getUnit_byRatio","units","concat","splice","id_sub_or_product","getlocalDetailProduct","unitCodeValue","unit","serviceTimeUnitMap","type","SERVICETIME","tchat","invoice_detail","createEInvoiceDetailTemplate","stt_rec0","inv_unitCode","inv_quantity","inv_unitPrice","ma_thue","barcode","_b","inv_itemCode","alertMessageDesktop","inv_itemName","inv_discountPercentage","roundTo4Decimal","addEInvoiceDetail","platformFee","calculatePlatformFee","_c","_d","_e","_f","totalDiscountAmount","_g","_h","_j","_k","vatAmount","details","data","vcode","msg","calculateNewPriceToUseSettingTax","unitPrice","discountAmount","taxSetting","taxPlatform","num","toFixed","settings","push","newInvoiceDetail","escrowShopee","getEscrowShopee","order_number_ecommerce","access_token","order_income","seller_transaction_fee","shipping_seller_protection_fee_amount","commission_fee","transactionsTiktok","getOrderStatementTransactionsTiktok","shop_cipher","app_key","toString","fee_and_tax_amount","date","setDate","getDate","startTime","endTime","json","start_time","end_time","limit","offset","trade_order_id","trans_type","listFee","getTransactionDetailsLazada","phi_co_dinh","calculateTotalLazadaFee","phi_xu_ly_don_hang","tiki","getSalesOrderDetailTiki","shipping_fee_discountAmount","seller_income_detail","discount_shipping_fee","seller_subsidy","Math","abs","total_seller_fee","typeFee","fee_name","rawAmount","amount","replace","i0","factory","providedIn"],"sourceRoot":"webpack:///"}